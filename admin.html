<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #ffffff; color: #4a5d23; transition: background 0.3s; }
    body.dark { background: #1a1a1a; color: #e5e7eb; }
    body.dark .bg-\[#f9faf8\], body.dark .bg-white { background: #2d2d2d !important; color: #e5e7eb; }
    .input-dark { background: #f9f9f9; border: 1px solid #d4d4d4; color: #4a5d23; padding: 10px; width: 100%; border-radius: 8px; outline: none; }
    .input-dark:focus { border-color: #708238; }
    .input-dark::placeholder { color: #8a9a5c; opacity: 0.8; }
    .btn-primary { background: #708238; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.3s; }
    .btn-primary:hover { background: #556b2f; }
    .tab { padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; flex: 1; text-align: center; color: #6b7c3a; }
    .tab.active { border-color: #708238; color: #4a5d23; font-weight: bold; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 10px; font-weight: bold; z-index: 9999; animation: toastIn 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .toast.success { background: #708238; color: white; }
    .toast.error { background: #dc2626; color: white; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(15px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
 </head>
 <body class="p-4 max-w-2xl mx-auto md:max-w-3xl min-h-screen">
   <div id="toast-container"></div>

   <div id="login-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
       <div class="bg-[#f9faf8] p-8 rounded-xl text-center w-full max-w-sm border border-[#e5e7e0] shadow-sm">
           <h2 class="text-2xl font-bold mb-4 text-[#4a5d23]">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
           <input type="password" id="admin-pass" class="input-dark text-center mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
           <button onclick="login()" class="btn-primary">Ø¯Ø®ÙˆÙ„</button>
       </div>
   </div>

   <div id="dashboard" class="hidden">
       <header class="flex justify-between items-center mb-4 border-b border-[#e5e7e0] pb-4">
           <h1 class="text-2xl font-bold text-[#708238]">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h1>
           <div class="flex items-center gap-2">
             <button onclick="toggleDark()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100">ğŸŒ™</button>
             <a href="index.html" target="_blank" class="px-3 py-1.5 rounded-lg bg-[#708238] text-white text-sm font-bold hover:opacity-90">Ø§Ù„Ù…ØªØ¬Ø±</a>
             <button onclick="confirmLogout()" class="text-red-500 text-sm font-bold hover:bg-red-50 px-2 py-1 rounded">Ø®Ø±ÙˆØ¬</button>
           </div>
       </header>
       <div class="grid grid-cols-3 gap-3 mb-6">
         <div class="bg-[#f9faf8] rounded-xl p-4 border border-[#e5e7e0] text-center">
           <p class="text-2xl font-black text-[#708238]" id="stat-products">0</p>
           <p class="text-xs text-gray-500">Ù…Ù†ØªØ¬</p>
         </div>
         <div class="bg-[#f9faf8] rounded-xl p-4 border border-[#e5e7e0] text-center">
           <p class="text-2xl font-black text-[#708238]" id="stat-orders">0</p>
           <p class="text-xs text-gray-500">Ø·Ù„Ø¨</p>
         </div>
         <div class="bg-[#f9faf8] rounded-xl p-4 border border-[#e5e7e0] text-center">
           <p class="text-2xl font-black text-green-600" id="stat-today">0</p>
           <p class="text-xs text-gray-500">Ø§Ù„ÙŠÙˆÙ…</p>
         </div>
       </div>

       <div class="flex mb-6 border-b border-gray-700">
           <div onclick="switchTab('products')" id="tab-products" class="tab active">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
           <div onclick="switchTab('orders')" id="tab-orders" class="tab">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</div>
       </div>

       <div id="sec-products">
           <div class="bg-[#f9faf8] p-4 rounded-xl mb-6 border border-[#e5e7e0]">
               <h3 class="font-bold mb-4 text-[#4a5d23]">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
               <div class="space-y-3">
                   <div class="border-2 border-dashed border-[#c5d4a8] p-4 text-center rounded-xl cursor-pointer hover:border-[#708238]" onclick="document.getElementById('file-in').click()">
                        <input type="file" id="file-in" multiple accept="image/*" class="hidden" onchange="handleFiles(this)">
                        <span class="text-[#6b7c3a] text-sm">Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±</span>
                   </div>
                   <div id="preview" class="flex gap-2 flex-wrap justify-center"></div>
                   <p id="img-status" class="text-xs text-center text-amber-600 hidden">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±...</p>
                   
                   <input id="new-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„" class="input-dark">
                   <div class="flex gap-2">
                       <input id="new-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="input-dark">
                       <select id="new-cat" class="input-dark">
                           <option value="Ø±Ø¬Ø§Ù„ÙŠ">Ø±Ø¬Ø§Ù„ÙŠ</option>
                           <option value="Ø­Ø±ÙŠÙ…ÙŠ">Ø­Ø±ÙŠÙ…ÙŠ</option>
                           <option value="Ø£Ø·ÙØ§Ù„ÙŠ">Ø£Ø·ÙØ§Ù„ÙŠ</option>
                       </select>
                   </div>
                   <div class="border-t border-[#e5e7e0] pt-3 mt-2">
                       <p class="text-sm font-bold text-[#4a5d23] mb-2">ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</p>
                       <div class="flex flex-wrap gap-2 mb-2" id="color-btns">
                           <button type="button" onclick="addColor('Ø£Ø³ÙˆØ¯')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-[#2d2d2d] text-white">Ø£Ø³ÙˆØ¯</button>
                           <button type="button" onclick="addColor('Ø£Ø¨ÙŠØ¶')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-white text-[#333] border-gray-300">Ø£Ø¨ÙŠØ¶</button>
                           <button type="button" onclick="addColor('Ø¨Ù†ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-amber-900 text-white">Ø¨Ù†ÙŠ</button>
                           <button type="button" onclick="addColor('Ø±Ù…Ø§Ø¯ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-gray-500 text-white">Ø±Ù…Ø§Ø¯ÙŠ</button>
                           <button type="button" onclick="addColor('ÙƒØ­Ù„ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-indigo-900 text-white">ÙƒØ­Ù„ÙŠ</button>
                           <button type="button" onclick="addColor('Ø£Ø­Ù…Ø±')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-red-600 text-white">Ø£Ø­Ù…Ø±</button>
                           <button type="button" onclick="addColor('ÙˆØ±Ø¯ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-pink-400 text-white">ÙˆØ±Ø¯ÙŠ</button>
                           <button type="button" onclick="addColor('Ø¨ÙŠØ¬')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-amber-200 text-[#333]">Ø¨ÙŠØ¬</button>
                           <button type="button" onclick="addColor('Ø£Ø²Ø±Ù‚')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-blue-600 text-white">Ø£Ø²Ø±Ù‚</button>
                           <button type="button" onclick="addCustomColor()" class="px-3 py-1.5 rounded-lg text-sm border-2 border-dashed border-[#708238] text-[#708238]">+ Ù„ÙˆÙ† Ø¢Ø®Ø±</button>
                       </div>
                       <div id="selected-colors" class="space-y-2 mb-2"></div>
                       <div id="size-options" class="flex flex-wrap gap-2 hidden">
                           <p class="w-full text-xs text-[#6b7c3a] mb-1">Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯:</p>
                       </div>
                   </div>
                   <button onclick="addProduct()" id="save-btn" class="btn-primary">Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± â˜ï¸</button>
               </div>
           </div>
           <div class="flex gap-2 mb-3">
             <input type="text" id="product-search" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." class="input-dark flex-1 py-2">
             <select id="product-cat-filter" class="input-dark w-32 py-2">
               <option value="">Ø§Ù„ÙƒÙ„</option>
               <option value="Ø±Ø¬Ø§Ù„ÙŠ">Ø±Ø¬Ø§Ù„ÙŠ</option>
               <option value="Ø­Ø±ÙŠÙ…ÙŠ">Ø­Ø±ÙŠÙ…ÙŠ</option>
               <option value="Ø£Ø·ÙØ§Ù„ÙŠ">Ø£Ø·ÙØ§Ù„ÙŠ</option>
             </select>
           </div>
           <div id="products-skeleton" class="space-y-2 hidden">
             <div class="p-3 rounded flex gap-3"><div class="w-12 h-12 skeleton"></div><div class="flex-1"><div class="h-4 skeleton w-3/4 mb-2"></div><div class="h-3 skeleton w-1/2"></div></div></div>
             <div class="p-3 rounded flex gap-3"><div class="w-12 h-12 skeleton"></div><div class="flex-1"><div class="h-4 skeleton w-3/4 mb-2"></div><div class="h-3 skeleton w-1/2"></div></div></div>
           </div>
           <div id="products-list" class="space-y-2">
               <p class="text-center text-gray-600 py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
           </div>
       </div>

       <div id="sec-orders" class="hidden">
           <div class="mb-4 flex flex-wrap gap-2 items-center justify-between">
               <h3 class="font-bold text-[#4a5d23]">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
               <div class="flex gap-2 items-center">
                 <select id="order-filter" class="input-dark py-1.5 text-sm w-36">
                   <option value="all">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                   <option value="today">Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</option>
                 </select>
                 <span id="orders-count" class="text-sm text-[#6b7c3a]">0 Ø·Ù„Ø¨</span>
               </div>
           </div>
           <div id="orders-skeleton" class="space-y-4 hidden">
             <div class="rounded-xl overflow-hidden p-4 border"><div class="h-6 skeleton w-1/3 mb-3"></div><div class="h-4 skeleton w-full mb-2"></div><div class="h-4 skeleton w-2/3"></div></div>
           </div>
           <div id="orders-list" class="space-y-4">
               <p class="text-center text-[#6b7c3a] py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
           </div>
       </div>
   </div>

   <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
       <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-4 border border-[#e5e7e0]">
           <h3 class="font-bold text-lg text-[#4a5d23] mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
           <div class="space-y-3 mb-4">
             <input type="text" id="edit-prod-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„" class="input-dark">
             <input type="number" id="edit-prod-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="input-dark">
           </div>
           <p class="text-sm font-bold text-[#6b7c3a] mb-2">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø§Ø¶ØºØ· âœ• Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹)</p>
           <div id="edit-colors-list" class="space-y-3"></div>
           <div class="flex gap-2 mt-4">
               <button onclick="closeEditModal()" class="flex-1 py-2 rounded border border-[#c5d4a8] text-[#4a5d23]">Ø¥Ù„ØºØ§Ø¡</button>
               <button onclick="saveProductEdits()" id="edit-save-btn" class="flex-1 py-2 rounded bg-[#708238] text-white font-bold">Ø­ÙØ¸</button>
           </div>
       </div>
   </div>

   <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
     <div class="bg-white rounded-xl p-6 max-w-sm text-center">
       <p id="confirm-msg" class="mb-4 font-bold"></p>
       <div class="flex gap-2">
         <button onclick="confirmCancel()" class="flex-1 py-2 rounded border">Ø¥Ù„ØºØ§Ø¡</button>
         <button id="confirm-ok-btn" class="flex-1 py-2 rounded bg-red-600 text-white font-bold">Ù†Ø¹Ù…</button>
       </div>
     </div>
   </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs",
      authDomain: "ahmed-shoes.firebaseapp.com",
      projectId: "ahmed-shoes",
      storageBucket: "ahmed-shoes.firebasestorage.app",
      messagingSenderId: "172928088473",
      appId: "1:172928088473:web:100f543fd097a8d5c33b08",
      measurementId: "G-S50TX0VMKE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.newImages = []; 
    window.newSizes = [];
    window.newColors = [];
    window.selectedColorForSizes = null;
    window.allProducts = [];
    window.allOrders = [];
    const SIZE_RANGES = { Ø±Ø¬Ø§Ù„ÙŠ: [41,42,43,44,45], Ø­Ø±ÙŠÙ…ÙŠ: [37,38,39,40,41], Ø£Ø·ÙØ§Ù„ÙŠ: [17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36] };

    function toast(msg, type='success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    window.toggleDark = function() {
        document.body.classList.toggle('dark');
        const icon = document.querySelector('[title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"]');
        if(icon) icon.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
        try { localStorage.setItem('adminDark', document.body.classList.contains('dark')); } catch(e){}
    };
    if(localStorage.getItem('adminDark')==='true') { document.body.classList.toggle('dark'); document.querySelector('[title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"]') && (document.querySelector('[title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"]').textContent='â˜€ï¸'); }

    window.confirmLogout = function() {
        if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) location.reload();
    }

    window.copyOrderDetails = function(id) {
        const o = window.allOrders?.find(x=>x.doc.id===id)?.o;
        if(!o) return toast('Ø®Ø·Ø£', 'error');
        const isMulti = o.items && o.items.length;
        const lines = isMulti ? o.items.map((it,i)=> `${i+1}. ${it.productName} - ${it.color} Ù…Ù‚Ø§Ø³ ${it.size} Ã— ${it.qty||1} = ${(it.price*(it.qty||1))} Ø¬.Ù…`).join('\n') : `${o.productName} ${o.color||''} Ù…Ù‚Ø§Ø³ ${o.size} = ${o.productPrice} Ø¬.Ù…`;
        const total = isMulti ? o.total : (o.productPrice||0);
        const text = `Ø§Ù„Ø·Ù„Ø¨:\n${lines}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬.Ù…\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${o.customerName}\nØ§Ù„Ù‡Ø§ØªÙ: ${o.customerPhone}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${o.customerAddress}`;
        navigator.clipboard?.writeText(text).then(()=> toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'));
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
    let audioCtx = null;
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø©
    document.body.addEventListener('click', initAudio);
    document.body.addEventListener('touchstart', initAudio);

    function showBrowserNotification() {
        if(!('Notification' in window)) return;
        if(Notification.permission === 'granted') {
            new Notification('ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®', { body: 'ÙˆØµÙ„Ùƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯! Ø§ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', icon: 'Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ® (3).png' });
        } else if(Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
    }

    function playNewOrderSound() {
        try {
            if (!audioCtx) initAudio();
            const playBeep = (freq, start, dur, type = 'sine') => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
                osc.start(audioCtx.currentTime + start);
                osc.stop(audioCtx.currentTime + start + dur);
            };
            // Ù†ØºÙ…Ø© ØªÙ†Ø¨ÙŠÙ‡
            playBeep(800, 0, 0.2, 'triangle'); 
            playBeep(600, 0.25, 0.4, 'triangle');
        } catch(e){ console.log('Audio blocked', e); }
    }

    let lastOrderCount = 0;
    function notifyNewOrder() {
        playNewOrderSound();
        toast('ğŸ›’ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„!', 'success');
        if(document.hidden) showBrowserNotification();
        
        // ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        let blink = setInterval(() => {
            document.title = (document.title === 'ğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!') ? 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' : 'ğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!';
        }, 1000);
        setTimeout(() => { clearInterval(blink); document.title = 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®'; }, 10000);

        const tabOrders = document.getElementById('tab-orders');
        if(tabOrders) {
            tabOrders.innerHTML = 'ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© <span class="animate-pulse text-red-600 font-bold text-xl">â—</span>';
        }
    }

    window.login = function() {
        if(document.getElementById('admin-pass').value === 'AM') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            if('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
            initAudio(); // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
            loadProducts();
            loadOrders();
        } else toast('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
    }

    window.switchTab = function(t) {
        document.getElementById('sec-products').classList.toggle('hidden', t !== 'products');
        document.getElementById('sec-orders').classList.toggle('hidden', t !== 'orders');
        document.getElementById('tab-products').className = t === 'products' ? 'tab active' : 'tab';
        document.getElementById('tab-orders').className = t === 'orders' ? 'tab active' : 'tab';
        if(t === 'orders') document.getElementById('tab-orders').innerHTML = 'ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©';
    }

    window.addColor = function(name) {
        if(window.newColors.some(c=>c.name===name)) return;
        window.newColors.push({name, sizes: []});
        renderSelectedColors();
    }
    window.addCustomColor = function() {
        const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†:');
        if(name && name.trim()) window.addColor(name.trim());
    }
    window.removeColor = function(name) {
        window.newColors = window.newColors.filter(c=>c.name!==name);
        if(window.selectedColorForSizes===name) window.selectedColorForSizes = null;
        renderSelectedColors();
        renderSizeOptions();
    }
    window.selectColorForSizes = function(name) {
        window.selectedColorForSizes = name;
        renderSelectedColors();
        renderSizeOptions();
    }
    function renderSelectedColors() {
        const el = document.getElementById('selected-colors');
        el.innerHTML = window.newColors.map(c => {
            const isSel = c.name === window.selectedColorForSizes;
            const sz = c.sizes.length ? ` (${c.sizes.join(',')})` : '';
            return `<div class="flex items-center gap-2 flex-wrap">
                <button type="button" onclick="selectColorForSizes('${c.name}')" class="px-3 py-1 rounded text-sm ${isSel?'bg-[#708238] text-white border-2 border-[#708238]':'bg-white border-2 border-[#c5d4a8] text-[#4a5d23]'}">${c.name}${sz}</button>
                <button type="button" onclick="removeColor('${c.name}')" class="text-red-600 text-xs">âœ•</button>
            </div>`;
        }).join('');
    }
    function renderSizeOptions() {
        const opts = document.getElementById('size-options');
        if(!window.selectedColorForSizes) { opts.classList.add('hidden'); return; }
        const cat = document.getElementById('new-cat').value;
        const sizes = SIZE_RANGES[cat] || SIZE_RANGES.Ø±Ø¬Ø§Ù„ÙŠ;
        const color = window.newColors.find(c=>c.name===window.selectedColorForSizes);
        opts.classList.remove('hidden');
        opts.innerHTML = '<p class="w-full text-xs text-[#6b7c3a] mb-1">Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯:</p>' + sizes.map(s => {
            const has = color.sizes.includes(s);
            return `<button type="button" onclick="toggleSizeForColor('${window.selectedColorForSizes}', ${s}, this)" class="px-3 py-1 rounded text-sm ${has?'bg-[#708238] text-white border-2 border-[#708238]':'bg-white border-2 border-[#c5d4a8] text-[#4a5d23]'}">${s}</button>`;
        }).join('');
    }
    window.toggleSizeForColor = function(colorName, s, btn) {
        const c = window.newColors.find(x=>x.name===colorName);
        if(!c) return;
        if(c.sizes.includes(s)) { c.sizes = c.sizes.filter(x=>x!==s); }
        else { c.sizes.push(s); c.sizes.sort((a,b)=>a-b); }
        renderSelectedColors();
        renderSizeOptions();
    }
    document.getElementById('new-cat').addEventListener('change', () => { if(window.selectedColorForSizes) renderSizeOptions(); });

    window.handleFiles = function(input) {
        window.newImages = [];
        document.getElementById('preview').innerHTML = '';
        document.getElementById('img-status').classList.remove('hidden');
        
        let processed = 0;
        const files = [...input.files].slice(0, 8);
        
        files.forEach(f => {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src=e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx=c.getContext('2d');
                    const maxWidth = 600;
                    c.width=maxWidth; c.height=img.height*(maxWidth/img.width);
                    ctx.drawImage(img,0,0,c.width,c.height);
                    const d = c.toDataURL('image/jpeg', 0.6);
                    window.newImages.push(d);
                    document.getElementById('preview').innerHTML+=`<img src="${d}" class="w-10 h-10 rounded border border-[#c5d4a8]">`;
                    processed++;
                    if(processed === files.length) {
                        document.getElementById('img-status').innerText = "âœ… Ø§Ù„ØµÙˆØ± Ø¬Ø§Ù‡Ø²Ø©";
                        document.getElementById('img-status').classList.replace('text-amber-600', 'text-[#708238]');
                    }
                }
            }; r.readAsDataURL(f);
        });
    }

    window.addProduct = async function() {
        const btn = document.getElementById('save-btn');
        const name = document.getElementById('new-name').value;
        const price = document.getElementById('new-price').value;
        const colorsValid = window.newColors.length && window.newColors.some(c=>c.sizes.length>0);
        
        if(!name || !price || !window.newImages.length) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        if(!colorsValid) return toast('Ø£Ø¶Ù Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ù…Ù‚Ø§Ø³Ø§ØªÙ‡', 'error');
        
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±...";
        btn.disabled = true;

        try {
            const colorsToSave = window.newColors.filter(c=>c.sizes.length>0);
            await addDoc(collection(db, "products"), {
                name: name,
                price: price,
                category: document.getElementById('new-cat').value,
                images: window.newImages,
                colors: colorsToSave,
                timestamp: Date.now()
            });
            alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
            document.getElementById('new-name').value = '';
            document.getElementById('new-price').value = '';
            document.getElementById('preview').innerHTML = '';
            window.newImages = [];
            window.newColors = [];
            window.selectedColorForSizes = null;
            renderSelectedColors();
            renderSizeOptions();
        } catch (e) {
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message, 'error');
        }
        btn.innerText = "Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± â˜ï¸";
        btn.disabled = false;
    }

    function renderProductsList(items) {
        const list = document.getElementById('products-list');
        const skel = document.getElementById('products-skeleton');
        skel?.classList.add('hidden');
        if(!items.length) { list.innerHTML = '<p class="text-center text-[#6b7c3a] py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>'; return; }
        list.innerHTML = items.map(({doc, p}) => {
            const colorsInfo = p.colors ? p.colors.map(c=>`${c.name}: ${c.sizes.join(',')}`).join(' | ') : (p.sizes ? `Ù‚Ø¯ÙŠÙ…: ${(p.sizes||[]).join(',')}` : '-');
            return `
            <div class="bg-[#f9faf8] p-3 rounded flex justify-between items-center border border-[#e5e7e0]">
                <div class="flex gap-2 items-center flex-1 min-w-0">
                    <img src="${(p.images||[])[0]}" class="w-12 h-12 rounded object-cover shrink-0">
                    <div class="min-w-0">
                        <div class="font-bold text-[#4a5d23]">${p.name}</div>
                        <div class="text-xs text-[#6b7c3a]">${p.price} Ø¬.Ù…</div>
                        <div class="text-[10px] text-gray-500 truncate">${colorsInfo}</div>
                    </div>
                </div>
                <div class="flex gap-1 shrink-0">
                    <button onclick="openEditModal('${doc.id}')" class="text-[#708238] text-sm border border-[#708238] px-2 py-1 rounded hover:bg-[#708238]/10">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="confirmDelProd('${doc.id}')" class="text-red-600 text-sm border border-red-300 p-1 rounded hover:bg-red-50">Ø­Ø°Ù</button>
                </div>
            </div>`;
        }).join('');
    }

    function filterAndRenderProducts() {
        const q = document.getElementById('product-search')?.value?.toLowerCase() || '';
        const cat = document.getElementById('product-cat-filter')?.value || '';
        let items = window.allProducts;
        if(cat) items = items.filter(x=>x.p.category===cat);
        if(q) items = items.filter(x=>(x.p.name||'').toLowerCase().includes(q));
        renderProductsList(items);
    }

    function loadProducts() {
        document.getElementById('products-skeleton')?.classList.remove('hidden');
        const q = query(collection(db, "products"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            window.allProducts = snapshot.docs.map(doc => ({ doc, p: doc.data() }));
            document.getElementById('stat-products').textContent = snapshot.size;
            filterAndRenderProducts();
        });
    }

    document.getElementById('product-search')?.addEventListener('input', filterAndRenderProducts);
    document.getElementById('product-cat-filter')?.addEventListener('change', filterAndRenderProducts);

    window.confirmDelProd = function(id) {
        const p = window.allProducts?.find(x=>x.doc.id===id)?.p;
        const name = p?.name || 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬';
        document.getElementById('confirm-msg').textContent = `Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŸ`;
        document.getElementById('confirm-ok-btn').onclick = async () => {
            await deleteDoc(doc(db, "products", id));
            document.getElementById('confirm-modal').classList.add('hidden');
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        };
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    window.confirmCancel = function() { document.getElementById('confirm-modal').classList.add('hidden'); }

    window.delProd = async function(id) {
        await deleteDoc(doc(db, "products", id));
    }

    window.editProductId = null;
    window.editProductColors = null;
    window.editSizesRange = [];
    function renderEditColorsList() {
        const list = document.getElementById('edit-colors-list');
        list.innerHTML = window.editProductColors.map((c, ci) => `
            <div class="border border-[#e5e7e0] rounded-lg p-3">
                <p class="font-bold text-[#4a5d23] text-sm mb-2">${c.name}</p>
                <div class="flex flex-wrap gap-1">
                    ${(c.sizes||[]).map(s => `<button type="button" onclick="removeSizeFromEdit(${ci}, ${s})" class="px-2 py-0.5 rounded text-xs bg-[#708238] text-white hover:bg-red-500" title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø³ (Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹)">${s} âœ•</button>`).join('')}
                </div>
                ${(c.sizes||[]).length===0 ? '<p class="text-xs text-red-500">Ù„Ø§ Ù…Ù‚Ø§Ø³Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©</p>' : ''}
            </div>
        `).join('');
    }
    window.openEditModal = async function(id) {
        window.editProductId = id;
        const snap = await getDocs(query(collection(db, "products"), orderBy("timestamp", "desc")));
        const d = snap.docs.find(x=>x.id===id);
        if(!d) return;
        const p = d.data();
        const cat = p.category || 'Ø±Ø¬Ø§Ù„ÙŠ';
        const ranges = { Ø±Ø¬Ø§Ù„ÙŠ: [41,42,43,44,45], Ø­Ø±ÙŠÙ…ÙŠ: [37,38,39,40,41], Ø£Ø·ÙØ§Ù„ÙŠ: [17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36] };
        if(p.colors && p.colors.length) {
            window.editProductColors = JSON.parse(JSON.stringify(p.colors));
        } else {
            window.editProductColors = [{ name: 'Ø§ÙØªØ±Ø§Ø¶ÙŠ', sizes: [...(p.sizes||[])] }];
        }
        document.getElementById('edit-prod-name').value = p.name || '';
        document.getElementById('edit-prod-price').value = p.price || '';
        renderEditColorsList();
        document.getElementById('edit-modal').classList.remove('hidden');
    }
    window.removeSizeFromEdit = function(colorIdx, size) {
        window.editProductColors[colorIdx].sizes = (window.editProductColors[colorIdx].sizes||[]).filter(s=>s!==size);
        renderEditColorsList();
    }
    window.closeEditModal = function() {
        document.getElementById('edit-modal').classList.add('hidden');
        window.editProductId = null;
    }
    window.saveProductEdits = async function() {
        const colorsToSave = window.editProductColors.filter(c=>c.sizes.length>0);
        if(colorsToSave.length===0) return toast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¨Ù‚Ù‰ Ù…Ù‚Ø§Ø³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        const name = document.getElementById('edit-prod-name').value?.trim();
        const price = document.getElementById('edit-prod-price').value;
        if(!name || !price) return toast('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†', 'error');
        document.getElementById('edit-save-btn').disabled = true;
        try {
            await updateDoc(doc(db, "products", window.editProductId), { colors: colorsToSave, name, price: parseFloat(price) || 0 });
            closeEditModal();
            toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        } catch (e) {
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message, 'error');
        }
        document.getElementById('edit-save-btn').disabled = false;
    }

    function renderOrdersList(orders) {
        const list = document.getElementById('orders-list');
        const skel = document.getElementById('orders-skeleton');
        skel?.classList.add('hidden');
        if(!orders.length) { list.innerHTML = '<p class="text-center text-[#6b7c3a] py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'; return; }
        list.innerHTML = orders.map(({doc, o}, idx) => {
                const orderNum = orders.length - idx;
                const ph = String(o.customerPhone||'').replace(/\D/g,'');
                const waNum = ph.startsWith('20') ? ph : '20' + ph.replace(/^0/,'');
                const isMulti = o.items && o.items.length;
                const itemsHtml = isMulti ? o.items.map((it,i) => `
                    <div class="flex justify-between py-2 border-b border-[#e5e7e0] last:border-0">
                        <span class="text-sm text-[#4a5d23]">${i+1}. ${it.productName} - ${it.color} | Ù…Ù‚Ø§Ø³ ${it.size} Ã— ${it.qty||1}</span>
                        <span class="text-[#708238] font-bold">${(it.price*(it.qty||1))} Ø¬.Ù…</span>
                    </div>
                `).join('') : `
                    <div class="flex justify-between py-2">
                        <span class="text-sm text-[#4a5d23]">${o.productName || '-'} ${o.color ? '- ' + o.color : ''} | Ù…Ù‚Ø§Ø³ ${o.size || '-'}</span>
                        <span class="text-[#708238] font-bold">${o.productPrice || 0} Ø¬.Ù…</span>
                    </div>
                `;
                const total = isMulti ? o.total : (o.productPrice || 0);
                return `
                    <div class="bg-white rounded-xl border border-[#e5e7e0] overflow-hidden shadow-sm hover:shadow-md transition">
                        <div class="bg-[#708238] text-white px-4 py-2 flex justify-between items-center">
                            <span class="font-bold">#${orderNum} - Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span>
                            <span class="text-sm opacity-90">${new Date(o.timestamp).toLocaleString('ar-EG')}</span>
                        </div>
                        <div class="p-4">
                            <div class="bg-[#f9faf8] rounded-lg p-3 mb-4">
                                <p class="text-xs font-bold text-[#6b7c3a] mb-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                                ${itemsHtml}
                                <div class="flex justify-between pt-2 mt-2 border-t-2 border-[#e5e7e0]">
                                    <span class="font-bold text-[#4a5d23]">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                    <span class="font-black text-[#708238]">${total} Ø¬.Ù…</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                <p class="text-xs font-bold text-gray-500 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                                <p class="text-sm">ğŸ‘¤ ${o.customerName}</p>
                                <p class="text-sm">ğŸ“ <a href="tel:${o.customerPhone}" class="text-[#708238] hover:underline font-bold">${o.customerPhone}</a></p>
                                <p class="text-sm">ğŸ“ ${o.customerAddress}</p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="copyOrderDetails('${doc.id}')" class="py-2 px-3 rounded-lg border border-[#708238] text-[#708238] text-sm font-bold hover:bg-[#708238]/10">ğŸ“‹ Ù†Ø³Ø®</button>
                                <a href="https://wa.me/${waNum}" target="_blank" class="flex-1 py-2 rounded-lg bg-green-600 text-white text-center text-sm font-bold hover:bg-green-700">ÙˆØ§ØªØ³Ø§Ø¨</a>
                                <button onclick="confirmDelOrder('${doc.id}')" class="flex-1 py-2 rounded-lg border border-red-300 text-red-600 text-sm font-bold hover:bg-red-50">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
                            </div>
                        </div>
                    </div>
                `;
        }).join('');
    }

    function filterAndRenderOrders() {
        const filter = document.getElementById('order-filter')?.value || 'all';
        let orders = window.allOrders;
        if(filter==='today') {
            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            orders = orders.filter(x=> x.o.timestamp >= todayStart.getTime());
        }
        document.getElementById('orders-count').textContent = orders.length + ' Ø·Ù„Ø¨';
        renderOrdersList(orders);
    }

    function loadOrders() {
        document.getElementById('orders-skeleton')?.classList.remove('hidden');
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            window.allOrders = snapshot.docs.map(doc => ({ doc, o: doc.data(), id: doc.id }));
            window.allOrders.forEach(x => x.id = x.doc.id);
            document.getElementById('stat-orders').textContent = snapshot.size;
            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            const todayCount = snapshot.docs.filter(d=> d.data().timestamp >= todayStart.getTime()).length;
            document.getElementById('stat-today').textContent = todayCount;
            if(snapshot.size > lastOrderCount && lastOrderCount > 0) notifyNewOrder();
            lastOrderCount = snapshot.size;
            filterAndRenderOrders();
        });
    }

    document.getElementById('order-filter')?.addEventListener('change', filterAndRenderOrders);

    window.confirmDelOrder = function(id) {
        const ord = window.allOrders?.find(x=>x.doc.id===id)?.o;
        document.getElementById('confirm-msg').textContent = 'Ù‡Ù„ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.';
        document.getElementById('confirm-ok-btn').onclick = async () => {
            await deleteDoc(doc(db, "orders", id));
            document.getElementById('confirm-modal').classList.add('hidden');
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        };
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    window.delOrder = async function(id) {
        await deleteDoc(doc(db, "orders", id));
    }
   </script>
 </body>
</html>
