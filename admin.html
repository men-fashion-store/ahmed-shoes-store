<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© | Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f3f4f6; }
        
        /* Login Screen */
        #login-screen { position: fixed; inset: 0; z-index: 9999; background: #fff; display: flex; align-items: center; justify-content: center; }
        
        /* Smart Add Styles */
        .size-checkbox:checked + div {
            background-color: #4b5f28; color: white; border-color: #4b5f28;
            transform: scale(1.05); box-shadow: 0 4px 6px rgba(75, 95, 40, 0.3);
        }
        .color-btn.active { ring: 4px solid #c5a059; transform: scale(1.1); }
        .tab { cursor: pointer; padding: 10px 20px; border-bottom: 3px solid transparent; font-weight: bold; color: #888; transition: 0.3s; }
        .tab.active { border-color: #4b5f28; color: #4b5f28; background: #e8f5e9; border-radius: 8px 8px 0 0; }
        
        /* Loader */
        .loader { border-top-color: #4b5f28; animation: spinner 1s linear infinite; }
        @keyframes spinner { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-full max-w-sm border border-gray-100">
            <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">ğŸ”</div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <p class="text-sm text-gray-500 mb-6">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" id="admin-pass" class="w-full p-4 bg-gray-50 border rounded-xl text-center font-bold text-lg mb-4 focus:border-[#4b5f28] outline-none" placeholder="****">
            <button onclick="checkLogin()" class="w-full bg-[#4b5f28] text-white py-4 rounded-xl font-bold shadow-lg hover:bg-[#3a4a1f] transition">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-6xl mx-auto p-4">
        
        <header class="flex flex-wrap gap-4 justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm">
            <div>
                <h1 class="text-2xl font-black text-[#4b5f28]">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</h1>
                <p class="text-xs text-gray-500 font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</p>
            </div>
            <div class="flex gap-2">
                <a href="index.html" target="_blank" class="px-4 py-2 bg-gray-100 rounded-xl font-bold text-sm hover:bg-gray-200">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØªØ¬Ø± ğŸ‘ï¸</a>
                <button onclick="logout()" class="px-4 py-2 bg-red-50 text-red-500 rounded-xl font-bold text-sm hover:bg-red-100">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-[#4b5f28] text-center">
                <p class="text-3xl font-black text-[#4b5f28]" id="stat-products">0</p>
                <p class="text-xs font-bold text-gray-400">Ù…Ù†ØªØ¬ Ù…ØªØ§Ø­</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-orange-400 text-center">
                <p class="text-3xl font-black text-orange-500" id="stat-orders">0</p>
                <p class="text-xs font-bold text-gray-400">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-400 text-center">
                <p class="text-3xl font-black text-blue-500" id="stat-today">0</p>
                <p class="text-xs font-bold text-gray-400">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="switchTab('products')" id="tab-products" class="tab active flex-1">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="tab flex-1">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
        </div>

        <div id="sec-products">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="bg-[#4b5f28] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                             Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
                        </h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input id="prod-name" class="w-full bg-gray-50 border p-3 rounded-xl font-bold focus:border-[#4b5f28] outline-none" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„">
                            <input id="prod-price" type="number" class="w-full bg-gray-50 border p-3 rounded-xl font-bold focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        </div>
                        <select id="prod-cat" onchange="updateSizeGrid()" class="w-full bg-green-50 border border-green-200 text-[#4b5f28] p-3 rounded-xl font-bold focus:outline-none cursor-pointer">
                            <option value="Ø±Ø¬Ø§Ù„ÙŠ">Ø±Ø¬Ø§Ù„ÙŠ (41 - 49)</option>
                            <option value="Ø­Ø±ÙŠÙ…ÙŠ">Ø­Ø±ÙŠÙ…ÙŠ (37 - 41)</option>
                            <option value="Ø£Ø·ÙØ§Ù„ÙŠ">Ø£Ø·ÙØ§Ù„ÙŠ (17 - 32)</option>
                        </select>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="bg-[#4b5f28] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                             ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª
                        </h3>
                        
                        <div class="flex flex-wrap gap-3 mb-6" id="color-palette">
                            <button onclick="activateColor('Ø£Ø³ÙˆØ¯')" class="color-btn w-10 h-10 rounded-full bg-black shadow-md transition hover:scale-110" title="Ø£Ø³ÙˆØ¯"></button>
                            <button onclick="activateColor('Ø£Ø¨ÙŠØ¶')" class="color-btn w-10 h-10 rounded-full bg-white border border-gray-300 shadow-md transition hover:scale-110" title="Ø£Ø¨ÙŠØ¶"></button>
                            <button onclick="activateColor('ÙƒØ­Ù„ÙŠ')" class="color-btn w-10 h-10 rounded-full bg-blue-900 shadow-md transition hover:scale-110" title="ÙƒØ­Ù„ÙŠ"></button>
                            <button onclick="activateColor('Ø¨Ù†ÙŠ')" class="color-btn w-10 h-10 rounded-full bg-amber-900 shadow-md transition hover:scale-110" title="Ø¨Ù†ÙŠ"></button>
                            <button onclick="activateColor('Ø¨ÙŠØ¬')" class="color-btn w-10 h-10 rounded-full bg-[#f5f5dc] border border-gray-300 shadow-md transition hover:scale-110" title="Ø¨ÙŠØ¬"></button>
                            <button onclick="activateColor('Ø±Ù…Ø§Ø¯ÙŠ')" class="color-btn w-10 h-10 rounded-full bg-gray-500 shadow-md transition hover:scale-110" title="Ø±Ù…Ø§Ø¯ÙŠ"></button>
                             <div class="flex items-center gap-1 mr-2 border-r pr-2">
                                <input id="custom-color-name" placeholder="Ù„ÙˆÙ† Ø¢Ø®Ø±.." class="w-20 text-xs p-2 border rounded-lg bg-gray-50">
                                <button onclick="addCustomColor()" class="bg-[#4b5f28] text-white w-8 h-8 rounded-lg text-lg font-bold">+</button>
                            </div>
                        </div>

                        <div id="size-section" class="hidden bg-gray-50 p-4 rounded-xl">
                            <div class="flex justify-between items-center mb-3">
                                <p class="font-bold text-gray-800">Ù…Ù‚Ø§Ø³Ø§Øª: <span id="active-color-name" class="text-[#4b5f28]">...</span></p>
                                <button onclick="selectAllSizes()" class="text-xs text-blue-500 underline">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                            </div>
                            <div id="sizes-grid" class="grid grid-cols-6 gap-2"></div>
                        </div>
                        
                        <div id="no-color-msg" class="text-center py-4 text-gray-400 text-sm">ğŸ‘ˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ù„ÙØªØ­ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</div>

                        <div id="stock-summary" class="mt-4 flex flex-wrap gap-2 text-xs text-gray-500 border-t pt-4"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="bg-[#4b5f28] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                             ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬
                        </h3>
                        <div class="border-2 border-dashed border-[#4b5f28] bg-green-50 rounded-xl p-6 text-center cursor-pointer hover:bg-green-100 transition" onclick="document.getElementById('img-file').click()">
                            <input type="file" id="img-file" multiple hidden onchange="handleImgSelect(this)">
                            <p class="text-3xl mb-2">ğŸ“¸</p>
                            <p class="text-sm font-bold text-[#4b5f28]">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±</p>
                            <p class="text-[10px] text-gray-500">Ø³ÙŠØªÙ… Ø§Ù„Ø¶ØºØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                        </div>
                        <div id="preview-area" class="grid grid-cols-3 gap-2 mt-4"></div>
                    </div>

                    <button onclick="uploadProduct()" id="upload-btn" class="w-full bg-[#4b5f28] text-white py-4 rounded-xl font-bold text-xl shadow-xl hover:shadow-2xl transition flex justify-center items-center gap-2">
                        <span>Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ ğŸš€</span>
                    </button>
                </div>
            </div>

            <h3 class="font-bold text-gray-800 text-xl mb-4 border-b pb-2">ğŸ“‹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
            <div id="products-list" class="space-y-3">
                <p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>

        <div id="sec-orders" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-gray-800">Ø§Ù„ÙˆØ§Ø±Ø¯ (Ø£Ø­Ø¯Ø« Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</h3>
                <span id="orders-count-badge" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-bold">0 Ø·Ù„Ø¨</span>
            </div>
            <div id="orders-list" class="space-y-4">
                <p class="text-center text-gray-400 py-10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
            </div>
        </div>

    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-sm text-center shadow-2xl">
            <p id="confirm-msg" class="mb-4 font-bold text-gray-800"></p>
            <div class="flex gap-2">
                <button onclick="closeConfirm()" class="flex-1 py-2 rounded border font-bold text-gray-500">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-ok-btn" class="flex-1 py-2 rounded bg-red-600 text-white font-bold">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[10000]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs",
            authDomain: "ahmed-shoes.firebaseapp.com",
            projectId: "ahmed-shoes",
            storageBucket: "ahmed-shoes.firebasestorage.app",
            messagingSenderId: "172928088473",
            appId: "1:172928088473:web:100f543fd097a8d5c33b08",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State & Config
        window.tempImages = [];
        window.stockData = {}; 
        window.activeColor = null;
        window.allOrders = [];
        
        const RANGES = {
            'Ø±Ø¬Ø§Ù„ÙŠ': {min: 41, max: 49},
            'Ø­Ø±ÙŠÙ…ÙŠ': {min: 37, max: 41},
            'Ø£Ø·ÙØ§Ù„ÙŠ': {min: 17, max: 32}
        };

        // --- Auth Logic ---
        window.checkLogin = () => {
            const pass = document.getElementById('admin-pass').value;
            if(pass === 'AM') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadData(); // Start fetching
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
            }
        };

        window.logout = () => location.reload();

        window.switchTab = (t) => {
            document.getElementById('sec-products').classList.toggle('hidden', t !== 'products');
            document.getElementById('sec-orders').classList.toggle('hidden', t !== 'orders');
            document.getElementById('tab-products').className = t === 'products' ? 'tab active flex-1' : 'tab flex-1';
            document.getElementById('tab-orders').className = t === 'orders' ? 'tab active flex-1' : 'tab flex-1';
        };

        // --- Data Loading ---
        function loadData() {
            // 1. Products
            const qProd = query(collection(db, "products"), orderBy("timestamp", "desc"));
            onSnapshot(qProd, (snap) => {
                document.getElementById('stat-products').innerText = snap.size;
                const list = document.getElementById('products-list');
                list.innerHTML = snap.docs.map(doc => {
                    const p = doc.data();
                    return `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div class="flex gap-3 items-center">
                            <img src="${p.images[0]}" class="w-12 h-12 rounded-lg object-cover">
                            <div>
                                <h4 class="font-bold text-gray-800">${p.name}</h4>
                                <p class="text-xs text-gray-500">${p.price} Ø¬.Ù… | ${p.category}</p>
                            </div>
                        </div>
                        <button onclick="deleteItem('products', '${doc.id}')" class="text-red-500 bg-red-50 px-3 py-1 rounded-lg text-sm font-bold">Ø­Ø°Ù</button>
                    </div>`;
                }).join('');
            });

            // 2. Orders
            const qOrders = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            onSnapshot(qOrders, (snap) => {
                window.allOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('stat-orders').innerText = snap.size;
                document.getElementById('orders-count-badge').innerText = snap.size + ' Ø·Ù„Ø¨';
                
                // Today count
                const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                const todayCount = window.allOrders.filter(o => o.timestamp >= todayStart.getTime()).length;
                document.getElementById('stat-today').innerText = todayCount;

                renderOrders();
            });
        }

        function renderOrders() {
            const list = document.getElementById('orders-list');
            if(window.allOrders.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-10">Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ù„Ø³Ù‡...</p>';
                return;
            }

            list.innerHTML = window.allOrders.map(o => {
                const date = new Date(o.timestamp).toLocaleString('ar-EG');
                const itemsHtml = o.items ? o.items.map(i => 
                    `<div class="flex justify-between text-sm py-1 border-b border-dashed border-gray-100 last:border-0">
                        <span>${i.productName} (${i.color} / ${i.size}) Ã— ${i.qty}</span>
                        <span class="font-bold text-[#4b5f28]">${i.price * i.qty}</span>
                    </div>`
                ).join('') : 'Ù…Ù†ØªØ¬ Ù‚Ø¯ÙŠÙ…';

                return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 p-3 flex justify-between items-center border-b border-gray-100">
                        <span class="font-bold text-gray-700">#${o.id.slice(0,6).toUpperCase()}</span>
                        <span class="text-xs text-gray-500">${date}</span>
                    </div>
                    <div class="p-4">
                        <div class="mb-3 bg-[#f9f9f9] p-3 rounded-lg">
                            ${itemsHtml}
                            <div class="flex justify-between pt-2 font-black text-gray-800">
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                <span>${o.total} Ø¬.Ù…</span>
                            </div>
                        </div>
                        <div class="text-sm space-y-1 mb-4">
                            <p>ğŸ‘¤ <b>${o.customerName}</b></p>
                            <p>ğŸ“ <a href="tel:${o.customerPhone}" class="text-blue-600 font-bold">${o.customerPhone}</a></p>
                            <p>ğŸ“ ${o.customerAddress}</p>
                        </div>
                        <div class="flex gap-2">
                             <a href="https://wa.me/20${o.customerPhone.replace(/^0/,'')}?text=Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${o.customerName.split(' ')[0]}ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®.." target="_blank" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold text-center text-sm hover:bg-green-600">ÙˆØ§ØªØ³Ø§Ø¨</a>
                            <button onclick="deleteItem('orders', '${o.id}')" class="flex-1 border border-red-200 text-red-500 py-2 rounded-lg font-bold text-center text-sm hover:bg-red-50">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø£Ø±Ø´ÙØ©)</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        window.deleteItem = (col, id) => {
            document.getElementById('confirm-msg').innerText = col === 'products' ? 'Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ' : 'Ù‡Ù„ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡.';
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-ok-btn').onclick = async () => {
                await deleteDoc(doc(db, col, id));
                document.getElementById('confirm-modal').classList.add('hidden');
            };
        };
        window.closeConfirm = () => document.getElementById('confirm-modal').classList.add('hidden');

        // --- Smart Upload Logic (Updated) ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        window.handleImgSelect = async (input) => {
            const files = [...input.files];
            document.getElementById('preview-area').innerHTML = '<p class="text-xs text-green-600 col-span-3 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ·...</p>';
            window.tempImages = [];
            for (const file of files) {
                const compressed = await compressImage(file);
                window.tempImages.push(compressed);
                document.getElementById('preview-area').innerHTML += `<img src="${compressed}" class="w-full h-20 object-cover rounded-lg border">`;
            }
            if(document.querySelector('#preview-area p')) document.querySelector('#preview-area p').remove();
        };

        window.activateColor = (name) => {
            window.activeColor = name;
            document.getElementById('no-color-msg').classList.add('hidden');
            document.getElementById('size-section').classList.remove('hidden');
            document.getElementById('active-color-name').innerText = name;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(!window.stockData[name]) window.stockData[name] = [];
            renderSizeGrid();
        };

        window.addCustomColor = () => {
            const name = document.getElementById('custom-color-name').value;
            if(name) { window.activateColor(name); document.getElementById('custom-color-name').value = ''; }
        }

        window.renderSizeGrid = () => {
            const cat = document.getElementById('prod-cat').value;
            const range = RANGES[cat];
            const grid = document.getElementById('sizes-grid');
            grid.innerHTML = '';
            const currentSelected = window.stockData[window.activeColor] || [];
            for(let i = range.min; i <= range.max; i++) {
                const isChecked = currentSelected.includes(i) ? 'checked' : '';
                grid.innerHTML += `
                    <label class="cursor-pointer select-none">
                        <input type="checkbox" class="size-checkbox hidden" value="${i}" ${isChecked} onchange="toggleSize(${i})">
                        <div class="w-full aspect-square flex items-center justify-center rounded-xl bg-gray-100 border-2 border-transparent font-bold text-gray-500 transition-all hover:bg-gray-200">${i}</div>
                    </label>`;
            }
        };
        
        window.updateSizeGrid = () => { if(window.activeColor) renderSizeGrid(); };

        window.toggleSize = (s) => {
            const arr = window.stockData[window.activeColor];
            if(arr.includes(s)) arr.splice(arr.indexOf(s), 1); else arr.push(s);
            if(arr.length===0) delete window.stockData[window.activeColor];
            renderSummary();
        };
        
        window.selectAllSizes = () => {
            document.querySelectorAll('.size-checkbox').forEach(c => { if(!c.checked) { c.checked=true; c.onchange(); }});
        };

        function renderSummary() {
            document.getElementById('stock-summary').innerHTML = Object.entries(window.stockData).map(([k,v]) => 
                `<span class="bg-gray-100 px-2 py-1 rounded border"><b>${k}:</b> ${v.join(',')}</span>`
            ).join('');
        }

        window.uploadProduct = async () => {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const cat = document.getElementById('prod-cat').value;
            const btn = document.getElementById('upload-btn');
            
            if(!name || !price || window.tempImages.length === 0 || Object.keys(window.stockData).length === 0) return alert('Ù†Ø§Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª! (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†)');
            
            btn.disabled = true;
            btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            
            try {
                const colorsArray = Object.entries(window.stockData).map(([k,v]) => ({name: k, sizes: v}));
                await addDoc(collection(db, "products"), {
                    name, price: Number(price), category: cat, images: window.tempImages, colors: colorsArray, timestamp: Date.now()
                });
                alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');
                location.reload();
            } catch(e) {
                alert('Ø®Ø·Ø£: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ ğŸš€';
            }
        };
    </script>
</body>
</html>
