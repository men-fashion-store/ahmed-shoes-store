<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #ffffff; color: #4a5d23; }
    .input-dark { background: #f9f9f9; border: 1px solid #d4d4d4; color: #4a5d23; padding: 10px; width: 100%; border-radius: 8px; outline: none; }
    .input-dark:focus { border-color: #708238; }
    .input-dark::placeholder { color: #8a9a5c; opacity: 0.8; }
    .btn-primary { background: #708238; color: white; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.3s; }
    .btn-primary:hover { background: #556b2f; }
    .tab { padding: 10px; cursor: pointer; border-bottom: 2px solid transparent; flex: 1; text-align: center; color: #6b7c3a; }
    .tab.active { border-color: #708238; color: #4a5d23; font-weight: bold; }
  </style>
 </head>
 <body class="p-4 max-w-2xl mx-auto md:max-w-3xl">

   <div id="login-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
       <div class="bg-[#f9faf8] p-8 rounded-xl text-center w-full max-w-sm border border-[#e5e7e0] shadow-sm">
           <h2 class="text-2xl font-bold mb-4 text-[#4a5d23]">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
           <input type="password" id="admin-pass" class="input-dark text-center mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
           <button onclick="login()" class="btn-primary">Ø¯Ø®ÙˆÙ„</button>
       </div>
   </div>

   <div id="dashboard" class="hidden">
       <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
           <h1 class="text-2xl font-bold text-[#708238]">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h1>
           <button onclick="location.reload()" class="text-red-400 text-sm">Ø®Ø±ÙˆØ¬</button>
       </header>

       <div class="flex mb-6 border-b border-gray-700">
           <div onclick="switchTab('products')" id="tab-products" class="tab active">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
           <div onclick="switchTab('orders')" id="tab-orders" class="tab">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</div>
       </div>

       <div id="sec-products">
           <div class="bg-[#f9faf8] p-4 rounded-xl mb-6 border border-[#e5e7e0]">
               <h3 class="font-bold mb-4 text-[#4a5d23]">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
               <div class="space-y-3">
                   <div class="border-2 border-dashed border-[#c5d4a8] p-4 text-center rounded-xl cursor-pointer hover:border-[#708238]" onclick="document.getElementById('file-in').click()">
                        <input type="file" id="file-in" multiple accept="image/*" class="hidden" onchange="handleFiles(this)">
                        <span class="text-[#6b7c3a] text-sm">Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±</span>
                   </div>
                   <div id="preview" class="flex gap-2 flex-wrap justify-center"></div>
                   <p id="img-status" class="text-xs text-center text-amber-600 hidden">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±...</p>
                   
                   <input id="new-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„" class="input-dark">
                   <div class="flex gap-2">
                       <input id="new-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="input-dark">
                       <select id="new-cat" class="input-dark">
                           <option value="Ø±Ø¬Ø§Ù„ÙŠ">Ø±Ø¬Ø§Ù„ÙŠ</option>
                           <option value="Ø­Ø±ÙŠÙ…ÙŠ">Ø­Ø±ÙŠÙ…ÙŠ</option>
                           <option value="Ø£Ø·ÙØ§Ù„ÙŠ">Ø£Ø·ÙØ§Ù„ÙŠ</option>
                       </select>
                   </div>
                   <div class="border-t border-[#e5e7e0] pt-3 mt-2">
                       <p class="text-sm font-bold text-[#4a5d23] mb-2">ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</p>
                       <div class="flex flex-wrap gap-2 mb-2" id="color-btns">
                           <button type="button" onclick="addColor('Ø£Ø³ÙˆØ¯')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-[#2d2d2d] text-white">Ø£Ø³ÙˆØ¯</button>
                           <button type="button" onclick="addColor('Ø£Ø¨ÙŠØ¶')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-white text-[#333] border-gray-300">Ø£Ø¨ÙŠØ¶</button>
                           <button type="button" onclick="addColor('Ø¨Ù†ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-amber-900 text-white">Ø¨Ù†ÙŠ</button>
                           <button type="button" onclick="addColor('Ø±Ù…Ø§Ø¯ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-gray-500 text-white">Ø±Ù…Ø§Ø¯ÙŠ</button>
                           <button type="button" onclick="addColor('ÙƒØ­Ù„ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-indigo-900 text-white">ÙƒØ­Ù„ÙŠ</button>
                           <button type="button" onclick="addColor('Ø£Ø­Ù…Ø±')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-red-600 text-white">Ø£Ø­Ù…Ø±</button>
                           <button type="button" onclick="addColor('ÙˆØ±Ø¯ÙŠ')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-pink-400 text-white">ÙˆØ±Ø¯ÙŠ</button>
                           <button type="button" onclick="addColor('Ø¨ÙŠØ¬')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-amber-200 text-[#333]">Ø¨ÙŠØ¬</button>
                           <button type="button" onclick="addColor('Ø£Ø²Ø±Ù‚')" class="px-3 py-1.5 rounded-lg text-sm border-2 border-[#c5d4a8] hover:border-[#708238] bg-blue-600 text-white">Ø£Ø²Ø±Ù‚</button>
                           <button type="button" onclick="addCustomColor()" class="px-3 py-1.5 rounded-lg text-sm border-2 border-dashed border-[#708238] text-[#708238]">+ Ù„ÙˆÙ† Ø¢Ø®Ø±</button>
                       </div>
                       <div id="selected-colors" class="space-y-2 mb-2"></div>
                       <div id="size-options" class="flex flex-wrap gap-2 hidden">
                           <p class="w-full text-xs text-[#6b7c3a] mb-1">Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯:</p>
                       </div>
                   </div>
                   <button onclick="addProduct()" id="save-btn" class="btn-primary">Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± â˜ï¸</button>
               </div>
           </div>
           <h3 class="mb-2 font-bold text-[#4a5d23]">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:</h3>
           <div id="products-list" class="space-y-2">
               <p class="text-center text-gray-600 py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
           </div>
       </div>

       <div id="sec-orders" class="hidden">
           <div class="mb-4 flex justify-between items-center">
               <h3 class="font-bold text-[#4a5d23]">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
               <span id="orders-count" class="text-sm text-[#6b7c3a]">0 Ø·Ù„Ø¨</span>
           </div>
           <div id="orders-list" class="space-y-4">
               <p class="text-center text-[#6b7c3a] py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
           </div>
       </div>
   </div>

   <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
       <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-4 border border-[#e5e7e0]">
           <h3 class="font-bold text-lg text-[#4a5d23] mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹)</h3>
           <p id="edit-prod-name" class="text-sm text-[#6b7c3a] mb-4"></p>
           <div id="edit-colors-list" class="space-y-3"></div>
           <div class="flex gap-2 mt-4">
               <button onclick="closeEditModal()" class="flex-1 py-2 rounded border border-[#c5d4a8] text-[#4a5d23]">Ø¥Ù„ØºØ§Ø¡</button>
               <button onclick="saveProductEdits()" id="edit-save-btn" class="flex-1 py-2 rounded bg-[#708238] text-white font-bold">Ø­ÙØ¸</button>
           </div>
       </div>
   </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âœ… ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ØªÙ… Ø¯Ù…Ø¬Ù‡)
    const firebaseConfig = {
      apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs",
      authDomain: "ahmed-shoes.firebaseapp.com",
      projectId: "ahmed-shoes",
      storageBucket: "ahmed-shoes.firebasestorage.app",
      messagingSenderId: "172928088473",
      appId: "1:172928088473:web:100f543fd097a8d5c33b08",
      measurementId: "G-S50TX0VMKE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.newImages = []; 
    window.newSizes = [];

    window.login = function() {
        if(document.getElementById('admin-pass').value === 'AM') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadProducts();
            loadOrders();
        } else alert('Ø®Ø·Ø£');
    }

    window.switchTab = function(t) {
        document.getElementById('sec-products').classList.toggle('hidden', t !== 'products');
        document.getElementById('sec-orders').classList.toggle('hidden', t !== 'orders');
        document.getElementById('tab-products').className = t === 'products' ? 'tab active' : 'tab';
        document.getElementById('tab-orders').className = t === 'orders' ? 'tab active' : 'tab';
    }

    window.addColor = function(name) {
        if(window.newColors.some(c=>c.name===name)) return;
        window.newColors.push({name, sizes: []});
        renderSelectedColors();
    }
    window.addCustomColor = function() {
        const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„ÙˆÙ†:');
        if(name && name.trim()) window.addColor(name.trim());
    }
    window.removeColor = function(name) {
        window.newColors = window.newColors.filter(c=>c.name!==name);
        if(window.selectedColorForSizes===name) window.selectedColorForSizes = null;
        renderSelectedColors();
        renderSizeOptions();
    }
    window.selectColorForSizes = function(name) {
        window.selectedColorForSizes = name;
        renderSelectedColors();
        renderSizeOptions();
    }
    function renderSelectedColors() {
        const el = document.getElementById('selected-colors');
        el.innerHTML = window.newColors.map(c => {
            const isSel = c.name === window.selectedColorForSizes;
            const sz = c.sizes.length ? ` (${c.sizes.join(',')})` : '';
            return `<div class="flex items-center gap-2 flex-wrap">
                <button type="button" onclick="selectColorForSizes('${c.name}')" class="px-3 py-1 rounded text-sm ${isSel?'bg-[#708238] text-white border-2 border-[#708238]':'bg-white border-2 border-[#c5d4a8] text-[#4a5d23]'}">${c.name}${sz}</button>
                <button type="button" onclick="removeColor('${c.name}')" class="text-red-600 text-xs">âœ•</button>
            </div>`;
        }).join('');
    }
    function renderSizeOptions() {
        const opts = document.getElementById('size-options');
        if(!window.selectedColorForSizes) { opts.classList.add('hidden'); return; }
        const cat = document.getElementById('new-cat').value;
        const sizes = SIZE_RANGES[cat] || SIZE_RANGES.Ø±Ø¬Ø§Ù„ÙŠ;
        const color = window.newColors.find(c=>c.name===window.selectedColorForSizes);
        opts.classList.remove('hidden');
        opts.innerHTML = '<p class="w-full text-xs text-[#6b7c3a] mb-1">Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯:</p>' + sizes.map(s => {
            const has = color.sizes.includes(s);
            return `<button type="button" onclick="toggleSizeForColor('${window.selectedColorForSizes}', ${s}, this)" class="px-3 py-1 rounded text-sm ${has?'bg-[#708238] text-white border-2 border-[#708238]':'bg-white border-2 border-[#c5d4a8] text-[#4a5d23]'}">${s}</button>`;
        }).join('');
    }
    window.toggleSizeForColor = function(colorName, s, btn) {
        const c = window.newColors.find(x=>x.name===colorName);
        if(!c) return;
        if(c.sizes.includes(s)) { c.sizes = c.sizes.filter(x=>x!==s); }
        else { c.sizes.push(s); c.sizes.sort((a,b)=>a-b); }
        renderSelectedColors();
        renderSizeOptions();
    }
    document.getElementById('new-cat').addEventListener('change', () => { if(window.selectedColorForSizes) renderSizeOptions(); });

    window.handleFiles = function(input) {
        window.newImages = [];
        document.getElementById('preview').innerHTML = '';
        document.getElementById('img-status').classList.remove('hidden');
        
        let processed = 0;
        const files = [...input.files].slice(0, 8);
        
        files.forEach(f => {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src=e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx=c.getContext('2d');
                    const maxWidth = 600;
                    c.width=maxWidth; c.height=img.height*(maxWidth/img.width);
                    ctx.drawImage(img,0,0,c.width,c.height);
                    const d = c.toDataURL('image/jpeg', 0.6);
                    window.newImages.push(d);
                    document.getElementById('preview').innerHTML+=`<img src="${d}" class="w-10 h-10 rounded border border-[#c5d4a8]">`;
                    processed++;
                    if(processed === files.length) {
                        document.getElementById('img-status').innerText = "âœ… Ø§Ù„ØµÙˆØ± Ø¬Ø§Ù‡Ø²Ø©";
                        document.getElementById('img-status').classList.replace('text-amber-600', 'text-[#708238]');
                    }
                }
            }; r.readAsDataURL(f);
        });
    }

    window.addProduct = async function() {
        const btn = document.getElementById('save-btn');
        const name = document.getElementById('new-name').value;
        const price = document.getElementById('new-price').value;
        const colorsValid = window.newColors.length && window.newColors.some(c=>c.sizes.length>0);
        
        if(!name || !price || !window.newImages.length) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        if(!colorsValid) return alert('Ø£Ø¶Ù Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ù…Ù‚Ø§Ø³Ø§ØªÙ‡');
        
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±...";
        btn.disabled = true;

        try {
            const colorsToSave = window.newColors.filter(c=>c.sizes.length>0);
            await addDoc(collection(db, "products"), {
                name: name,
                price: price,
                category: document.getElementById('new-cat').value,
                images: window.newImages,
                colors: colorsToSave,
                timestamp: Date.now()
            });
            alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
            document.getElementById('new-name').value = '';
            document.getElementById('preview').innerHTML = '';
            window.newImages = [];
            window.newColors = [];
            window.selectedColorForSizes = null;
            renderSelectedColors();
            renderSizeOptions();
        } catch (e) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
        }
        btn.innerText = "Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± â˜ï¸";
        btn.disabled = false;
    }

    function loadProducts() {
        const q = query(collection(db, "products"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('products-list');
            list.innerHTML = "";
            if(snapshot.empty) list.innerHTML = '<p class="text-center text-[#6b7c3a]">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>';
            snapshot.forEach((doc) => {
                const p = doc.data();
                const colorsInfo = p.colors ? p.colors.map(c=>`${c.name}: ${c.sizes.join(',')}`).join(' | ') : (p.sizes ? `Ù‚Ø¯ÙŠÙ…: ${(p.sizes||[]).join(',')}` : '-');
                list.innerHTML += `
                    <div class="bg-[#f9faf8] p-3 rounded flex justify-between items-center border border-[#e5e7e0]">
                        <div class="flex gap-2 items-center flex-1 min-w-0">
                            <img src="${(p.images||[])[0]}" class="w-12 h-12 rounded object-cover shrink-0">
                            <div class="min-w-0">
                                <div class="font-bold text-[#4a5d23]">${p.name}</div>
                                <div class="text-xs text-[#6b7c3a]">${p.price} Ø¬.Ù…</div>
                                <div class="text-[10px] text-gray-500 truncate">${colorsInfo}</div>
                            </div>
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button onclick="openEditModal('${doc.id}')" class="text-[#708238] text-sm border border-[#708238] px-2 py-1 rounded hover:bg-[#708238]/10">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="delProd('${doc.id}')" class="text-red-600 text-sm border border-red-300 p-1 rounded hover:bg-red-50">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            });
        });
    }

    window.delProd = async function(id) {
        if(confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŸ')) {
            await deleteDoc(doc(db, "products", id));
        }
    }

    window.editProductId = null;
    window.editProductColors = null;
    window.editSizesRange = [];
    function renderEditColorsList() {
        const list = document.getElementById('edit-colors-list');
        list.innerHTML = window.editProductColors.map((c, ci) => `
            <div class="border border-[#e5e7e0] rounded-lg p-3">
                <p class="font-bold text-[#4a5d23] text-sm mb-2">${c.name}</p>
                <div class="flex flex-wrap gap-1">
                    ${(c.sizes||[]).map(s => `<button type="button" onclick="removeSizeFromEdit(${ci}, ${s})" class="px-2 py-0.5 rounded text-xs bg-[#708238] text-white hover:bg-red-500" title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø³ (Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹)">${s} âœ•</button>`).join('')}
                </div>
                ${(c.sizes||[]).length===0 ? '<p class="text-xs text-red-500">Ù„Ø§ Ù…Ù‚Ø§Ø³Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©</p>' : ''}
            </div>
        `).join('');
    }
    window.openEditModal = async function(id) {
        window.editProductId = id;
        const snap = await getDocs(query(collection(db, "products"), orderBy("timestamp", "desc")));
        const d = snap.docs.find(x=>x.id===id);
        if(!d) return;
        const p = d.data();
        const cat = p.category || 'Ø±Ø¬Ø§Ù„ÙŠ';
        const ranges = { Ø±Ø¬Ø§Ù„ÙŠ: [41,42,43,44,45], Ø­Ø±ÙŠÙ…ÙŠ: [37,38,39,40,41], Ø£Ø·ÙØ§Ù„ÙŠ: [17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36] };
        if(p.colors && p.colors.length) {
            window.editProductColors = JSON.parse(JSON.stringify(p.colors));
        } else {
            window.editProductColors = [{ name: 'Ø§ÙØªØ±Ø§Ø¶ÙŠ', sizes: [...(p.sizes||[])] }];
        }
        document.getElementById('edit-prod-name').innerText = p.name;
        renderEditColorsList();
        document.getElementById('edit-modal').classList.remove('hidden');
    }
    window.removeSizeFromEdit = function(colorIdx, size) {
        window.editProductColors[colorIdx].sizes = (window.editProductColors[colorIdx].sizes||[]).filter(s=>s!==size);
        renderEditColorsList();
    }
    window.closeEditModal = function() {
        document.getElementById('edit-modal').classList.add('hidden');
        window.editProductId = null;
    }
    window.saveProductEdits = async function() {
        const colorsToSave = window.editProductColors.filter(c=>c.sizes.length>0);
        if(colorsToSave.length===0) return alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¨Ù‚Ù‰ Ù…Ù‚Ø§Ø³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        document.getElementById('edit-save-btn').disabled = true;
        try {
            await updateDoc(doc(db, "products", window.editProductId), { colors: colorsToSave });
            closeEditModal();
        } catch (e) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + e.message);
        }
        document.getElementById('edit-save-btn').disabled = false;
    }

    function loadOrders() {
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('orders-list');
            list.innerHTML = "";
            document.getElementById('orders-count').innerText = snapshot.size + ' Ø·Ù„Ø¨';
            if(snapshot.empty) list.innerHTML = '<p class="text-center text-[#6b7c3a] py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
            snapshot.forEach((doc, idx) => {
                const o = doc.data();
                const orderNum = snapshot.size - idx;
                const ph = String(o.customerPhone||'').replace(/\D/g,'');
                const waNum = ph.startsWith('20') ? ph : '20' + ph.replace(/^0/,'');
                const isMulti = o.items && o.items.length;
                const itemsHtml = isMulti ? o.items.map((it,i) => `
                    <div class="flex justify-between py-2 border-b border-[#e5e7e0] last:border-0">
                        <span class="text-sm text-[#4a5d23]">${i+1}. ${it.productName} - ${it.color} | Ù…Ù‚Ø§Ø³ ${it.size} Ã— ${it.qty||1}</span>
                        <span class="text-[#708238] font-bold">${(it.price*(it.qty||1))} Ø¬.Ù…</span>
                    </div>
                `).join('') : `
                    <div class="flex justify-between py-2">
                        <span class="text-sm text-[#4a5d23]">${o.productName || '-'} ${o.color ? '- ' + o.color : ''} | Ù…Ù‚Ø§Ø³ ${o.size || '-'}</span>
                        <span class="text-[#708238] font-bold">${o.productPrice || 0} Ø¬.Ù…</span>
                    </div>
                `;
                const total = isMulti ? o.total : (o.productPrice || 0);
                list.innerHTML += `
                    <div class="bg-white rounded-xl border border-[#e5e7e0] overflow-hidden shadow-sm hover:shadow-md transition">
                        <div class="bg-[#708238] text-white px-4 py-2 flex justify-between items-center">
                            <span class="font-bold">#${orderNum} - Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span>
                            <span class="text-sm opacity-90">${new Date(o.timestamp).toLocaleString('ar-EG')}</span>
                        </div>
                        <div class="p-4">
                            <div class="bg-[#f9faf8] rounded-lg p-3 mb-4">
                                <p class="text-xs font-bold text-[#6b7c3a] mb-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                                ${itemsHtml}
                                <div class="flex justify-between pt-2 mt-2 border-t-2 border-[#e5e7e0]">
                                    <span class="font-bold text-[#4a5d23]">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                    <span class="font-black text-[#708238]">${total} Ø¬.Ù…</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                <p class="text-xs font-bold text-gray-500 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                                <p class="text-sm">ğŸ‘¤ ${o.customerName}</p>
                                <p class="text-sm">ğŸ“ <a href="tel:${o.customerPhone}" class="text-[#708238] hover:underline font-bold">${o.customerPhone}</a></p>
                                <p class="text-sm">ğŸ“ ${o.customerAddress}</p>
                            </div>
                            <div class="flex gap-2">
                                <a href="https://wa.me/${waNum}" target="_blank" class="flex-1 py-2 rounded-lg bg-green-600 text-white text-center text-sm font-bold hover:bg-green-700">ÙˆØ§ØªØ³Ø§Ø¨</a>
                                <button onclick="delOrder('${doc.id}')" class="flex-1 py-2 rounded-lg border border-red-300 text-red-600 text-sm font-bold hover:bg-red-50">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
    }

    window.delOrder = async function(id) {
        if(confirm('Ù‡Ù„ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡.')) {
            await deleteDoc(doc(db, "orders", id));
        }
    }
   </script>
 </body>
</html>
