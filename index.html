<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4b5f28">
  <title>Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ® - Ù„Ù„Ø£Ø­Ø°ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { brand: { light: '#F3F4F6', DEFAULT: '#4b5f28', text: '#2d3748', accent: '#708238' } },
          animation: { 'float': 'float 3s ease-in-out infinite' },
          keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } } }
        } 
      } 
    }
  </script>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
    .btn-shine { position: relative; overflow: hidden; }
    .btn-shine::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transition: 0.5s; }
    .btn-shine:hover::after { left: 100%; }
    /* ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ø±Øª Ø§Ù„Ø·Ù„Ø¨ */
    .order-card { border-right: 4px solid #4b5f28; background: white; margin-bottom: 10px; border-radius: 8px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  </style>
 </head>
 <body class="min-h-screen bg-gray-50 pb-20">
   
   <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[9999]"></div>

   <button onclick="openCart()" class="fixed bottom-6 left-6 z-40 w-16 h-16 bg-[#4b5f28] text-white rounded-full shadow-2xl flex items-center justify-center animate-float hover:scale-110 transition border-4 border-white">
     <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
     <span id="cart-badge" class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-xs font-bold flex items-center justify-center border-2 border-white hidden">0</span>
   </button>

   <div id="home-view" class="max-w-md mx-auto min-h-screen flex flex-col relative">
     
     <div class="pt-10 pb-6 px-6 text-center relative overflow-hidden bg-white rounded-b-[2.5rem] shadow-sm mb-6">
        <div class="w-32 h-32 mx-auto rounded-full p-1 border-4 border-[#4b5f28]/10 mb-3 relative">
            <img src="Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ® (3).png" class="w-full h-full rounded-full object-contain bg-white shadow-sm" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
            <div id="login-status-dot" class="absolute bottom-2 right-2 w-4 h-4 bg-gray-300 border-2 border-white rounded-full"></div>
        </div>
        <h1 class="text-2xl font-black text-gray-800 mb-1" id="user-greeting">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
        <p class="text-gray-400 text-xs font-bold tracking-widest uppercase">Luxury Footwear</p>
        
        <div class="flex justify-center gap-3 mt-4">
            <button onclick="checkLoginAndAction('orders')" class="px-4 py-2 bg-gray-50 text-[#4b5f28] rounded-full text-sm font-bold border border-gray-200 hover:bg-[#4b5f28] hover:text-white transition flex items-center gap-2">
                ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ
            </button>
            <button onclick="handleAuthClick()" id="auth-btn" class="px-4 py-2 bg-[#4b5f28] text-white rounded-full text-sm font-bold shadow-lg hover:bg-[#3a4a1f] transition">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </button>
        </div>
     </div>

     <div class="px-4 space-y-4 flex-1">
       <button onclick="showCategory('Ø±Ø¬Ø§Ù„ÙŠ')" class="w-full h-32 rounded-2xl relative overflow-hidden group shadow-md transition hover:-translate-y-1">
         <img src="men.jpg" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/400x150?text=Men'">
         <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-2xl font-black border-b-2 border-white pb-1">Ø±Ø¬Ø§Ù„ÙŠ</h3></div>
       </button>
       <button onclick="showCategory('Ø­Ø±ÙŠÙ…ÙŠ')" class="w-full h-32 rounded-2xl relative overflow-hidden group shadow-md transition hover:-translate-y-1">
         <img src="women.jpg" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/400x150?text=Women'">
         <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-2xl font-black border-b-2 border-white pb-1">Ø­Ø±ÙŠÙ…ÙŠ</h3></div>
       </button>
       <button onclick="showCategory('Ø£Ø·ÙØ§Ù„ÙŠ')" class="w-full h-32 rounded-2xl relative overflow-hidden group shadow-md transition hover:-translate-y-1">
         <img src="kids.jpg" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/400x150?text=Kids'">
         <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-2xl font-black border-b-2 border-white pb-1">Ø£Ø·ÙØ§Ù„ÙŠ</h3></div>
       </button>
     </div>
     
     <div class="text-center py-6 text-gray-300 text-xs">A H M E D E L S H E K H</div>
   </div>

   <div id="products-view" class="hidden min-h-screen bg-white">
     <div class="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b px-4 py-3 flex items-center justify-between shadow-sm">
        <button onclick="goHome()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full font-bold text-gray-600">â†</button>
        <h2 id="cat-title" class="font-bold text-lg text-[#4b5f28]"></h2>
        <div class="w-8"></div>
     </div>
     <div id="grid" class="grid grid-cols-2 gap-3 p-3 pb-24"></div>
     <div id="loader" class="text-center py-20 hidden"><span class="text-2xl animate-spin inline-block">â³</span></div>
   </div>

   <div id="product-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4">
     <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl overflow-hidden max-h-[90vh] flex flex-col relative animate-float" style="animation: slideUp 0.3s ease-out">
       <button onclick="closeModal()" class="absolute top-4 left-4 z-10 w-8 h-8 bg-white/80 rounded-full font-bold shadow-sm">âœ•</button>
       <div class="h-64 bg-gray-100 p-4"><img id="m-img" class="w-full h-full object-contain mix-blend-multiply"></div>
       <div class="p-6 space-y-4 bg-white flex-1 overflow-y-auto">
         <div class="flex justify-between items-start">
            <h2 id="m-name" class="text-xl font-bold text-gray-800"></h2>
            <span id="m-price" class="text-xl font-black text-[#4b5f28]"></span>
         </div>
         <div id="colors-area" class="hidden">
             <p class="text-xs font-bold text-gray-400 mb-2">Ø§Ù„Ù„ÙˆÙ†</p>
             <div id="m-colors" class="flex flex-wrap gap-2"></div>
         </div>
         <div>
             <p class="text-xs font-bold text-gray-400 mb-2">Ø§Ù„Ù…Ù‚Ø§Ø³</p>
             <div id="m-sizes" class="flex flex-wrap gap-2"></div>
         </div>
         <button onclick="addToCart()" class="w-full py-3.5 bg-[#4b5f28] text-white font-bold rounded-xl shadow-lg btn-shine mt-2">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’</button>
       </div>
     </div>
   </div>

   <div id="login-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
       <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
           <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="absolute top-3 left-3 text-gray-400 text-xl">âœ•</button>
           
           <div class="text-center mb-6">
               <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">ğŸ”</div>
               <h3 class="text-xl font-bold text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹</h3>
               <p class="text-xs text-gray-500">Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ ÙˆÙ‡Ù†ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒ</p>
           </div>

           <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
               <div>
                   <label class="block text-xs font-bold text-gray-600 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                   <input type="tel" id="login-phone" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-center text-lg outline-none focus:border-[#4b5f28]" placeholder="01xxxxxxxxx" required>
               </div>
               
               <div id="new-user-fields" class="hidden space-y-4 border-t pt-4">
                   <p class="text-xs text-green-600 font-bold text-center">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙˆÙ„ Ù…Ø±Ø©! Ø¹Ø±ÙÙ†Ø§ Ø¨ÙŠÙƒ Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                   <input type="text" id="login-name" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                   <input type="text" id="login-address" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
               </div>

               <button type="submit" id="login-btn-submit" class="w-full py-3 bg-[#4b5f28] text-white font-bold rounded-xl shadow-lg">Ù…ØªØ§Ø¨Ø¹Ø© â”</button>
           </form>
       </div>
   </div>

   <div id="orders-modal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
       <div class="bg-gray-50 w-full sm:max-w-md h-[80vh] sm:h-auto sm:max-h-[80vh] rounded-t-3xl sm:rounded-2xl flex flex-col shadow-2xl">
           <div class="p-4 bg-white border-b flex justify-between items-center rounded-t-3xl sm:rounded-2xl">
               <h3 class="font-bold text-lg text-[#4b5f28]">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
               <button onclick="document.getElementById('orders-modal').classList.add('hidden')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-600 font-bold">âœ•</button>
           </div>
           <div id="orders-list" class="flex-1 overflow-y-auto p-4 space-y-3">
               <p class="text-center text-gray-400 py-10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
           </div>
       </div>
   </div>

   <div id="cart-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex justify-end">
     <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl" style="animation: slideLeft 0.3s">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h2 class="font-bold text-lg">ğŸ›’ Ø§Ù„Ø³Ù„Ø©</h2>
            <button onclick="closeCart()" class="text-gray-500 font-bold text-xl">âœ•</button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div class="p-4 border-t bg-gray-50">
            <div class="flex justify-between font-bold text-lg mb-4">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span id="cart-total" class="text-[#4b5f28]">0 Ø¬.Ù…</span>
            </div>
            <button onclick="checkout()" class="w-full py-4 bg-[#4b5f28] text-white font-bold rounded-xl shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
        </div>
     </div>
   </div>

   <script src="card.js"></script>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs",
      authDomain: "ahmed-shoes.firebaseapp.com",
      projectId: "ahmed-shoes",
      storageBucket: "ahmed-shoes.firebasestorage.app",
      messagingSenderId: "172928088473",
      appId: "1:172928088473:web:100f543fd097a8d5c33b08",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Login System) ---
    window.currentUser = JSON.parse(localStorage.getItem('userData')) || null;

    function updateUIForUser() {
        const btn = document.getElementById('auth-btn');
        const greeting = document.getElementById('user-greeting');
        const dot = document.getElementById('login-status-dot');

        if(window.currentUser) {
            btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬';
            btn.classList.replace('bg-[#4b5f28]', 'bg-red-500');
            btn.onclick = logout;
            greeting.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${window.currentUser.name.split(' ')[0]} ğŸ‘‹`;
            dot.classList.replace('bg-gray-300', 'bg-green-500');
        } else {
            btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            btn.classList.replace('bg-red-500', 'bg-[#4b5f28]');
            btn.onclick = handleAuthClick;
            greeting.textContent = 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹';
            dot.classList.replace('bg-green-500', 'bg-gray-300');
        }
    }
    
    window.handleAuthClick = function() {
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('login-phone').focus();
    }

    window.logout = function() {
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
            localStorage.removeItem('userData');
            window.currentUser = null;
            updateUIForUser();
            toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        }
    }

    // --- Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ù„Ø³ ---
    window.handleLoginSubmit = async function(e) {
        e.preventDefault();
        const phone = document.getElementById('login-phone').value.trim();
        const btn = document.getElementById('login-btn-submit');
        const nameInput = document.getElementById('login-name');
        const addrInput = document.getElementById('login-address');
        const newFields = document.getElementById('new-user-fields');

        if(!phone || phone.length < 11) return toast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');

        btn.disabled = true;
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

        try {
            // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userRef = doc(db, "users", phone);
            const userSnap = await getDoc(userRef);

            if(userSnap.exists()) {
                // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ -> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                const userData = userSnap.data();
                loginSuccess(userData);
            } else {
                // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -> Ù‡Ù„ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…ØŸ
                if(newFields.classList.contains('hidden')) {
                    // Ø£ÙˆÙ„ Ù…Ø±Ø© Ù†Ø¶ØºØ· -> Ø§Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„
                    newFields.classList.remove('hidden');
                    btn.innerText = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØ¯Ø®ÙˆÙ„';
                    btn.disabled = false;
                    toast('Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯! ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ');
                } else {
                    // ØªØ§Ù†ÙŠ Ù…Ø±Ø© Ù†Ø¶ØºØ· -> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const name = nameInput.value.trim();
                    const address = addrInput.value.trim();
                    if(!name || !address) {
                        btn.disabled = false;
                        return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†', 'error');
                    }

                    const newUser = { name, phone, address, joinedAt: Date.now() };
                    await setDoc(userRef, newUser);
                    loginSuccess(newUser);
                }
            }
        } catch(e) {
            console.error(e);
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            btn.disabled = false;
            btn.innerText = 'Ù…ØªØ§Ø¨Ø¹Ø© â”';
        }
    }

    function loginSuccess(userData) {
        localStorage.setItem('userData', JSON.stringify(userData));
        window.currentUser = userData;
        updateUIForUser();
        document.getElementById('login-modal').classList.add('hidden');
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙˆØ±Ù…
        document.getElementById('login-phone').value = '';
        document.getElementById('new-user-fields').classList.add('hidden');
        document.getElementById('login-btn-submit').innerText = 'Ù…ØªØ§Ø¨Ø¹Ø© â”';
        document.getElementById('login-btn-submit').disabled = false;
        
        toast(`Ù†ÙˆØ±Øª ÙŠØ§ ${userData.name.split(' ')[0]} â¤ï¸`);
        
        // Ù„Ùˆ ÙƒØ§Ù† Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØ¹Ù…Ù„ Ø­Ø§Ø¬Ø© (Ø²ÙŠ ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª) Ù†ÙØªØ­Ù‡Ø§
        if(window.pendingAction === 'orders') {
            openMyOrders();
            window.pendingAction = null;
        }
    }

    // --- Ø±Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª (My Orders) ---
    window.checkLoginAndAction = function(action) {
        if(!window.currentUser) {
            window.pendingAction = action;
            toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„');
            handleAuthClick();
        } else {
            if(action === 'orders') openMyOrders();
        }
    }

    window.openMyOrders = async function() {
        document.getElementById('orders-modal').classList.remove('hidden');
        const list = document.getElementById('orders-list');
        list.innerHTML = '<p class="text-center text-gray-400 py-10"><span class="inline-block animate-spin text-2xl">â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§ØªÙƒ...</p>';

        try {
            const q = query(collection(db, "orders"), where("customerPhone", "==", window.currentUser.phone), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);

            if(snap.empty) {
                list.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-5xl opacity-30 mb-2">ğŸ“¦</div>
                        <p class="font-bold text-gray-500">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª</p>
                        <button onclick="document.getElementById('orders-modal').classList.add('hidden')" class="text-[#4b5f28] text-sm font-bold mt-2">Ø§Ø·Ù„Ø¨ Ø¯Ù„ÙˆÙ‚ØªÙŠ</button>
                    </div>`;
                return;
            }

            list.innerHTML = snap.docs.map(d => {
                const o = d.data();
                const date = new Date(o.timestamp).toLocaleDateString('ar-EG');
                const itemsCount = o.items ? o.items.length : 1;
                const title = o.items ? o.items.map(i=>i.productName).join(' + ') : o.productName;
                
                return `
                <div class="order-card">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-black text-gray-800 text-sm">#${d.id.slice(0,6).toUpperCase()}</p>
                            <p class="text-xs text-gray-500">${date}</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded-full">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                    </div>
                    <p class="text-sm font-bold text-gray-700 truncate mb-1">${title}</p>
                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        <span class="text-xs text-gray-500">${itemsCount} Ù…Ù†ØªØ¬Ø§Øª</span>
                        <span class="font-black text-[#4b5f28]">${o.total} Ø¬.Ù…</span>
                    </div>
                </div>`;
            }).join('');

        } catch(e) {
            console.error(e);
            list.innerHTML = '<p class="text-center text-red-500 py-4">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
        }
    }

    // --- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø³Ù„Ø© ---
    window.allProducts = [];
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    getDocs(query(collection(db, "products"), orderBy("timestamp", "desc"))).then(snap => {
        window.allProducts = [];
        snap.forEach(doc => window.allProducts.push({id: doc.id, ...doc.data()}));
    });

    window.showCategory = function(cat) {
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('products-view').classList.remove('hidden');
        document.getElementById('cat-title').innerText = cat;
        
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const items = window.allProducts.filter(p => p.category === cat);
        
        if(!items.length) {
            grid.innerHTML = '<p class="col-span-2 text-center text-gray-400 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            return;
        }

        grid.innerHTML = items.map(p => `
            <div onclick="openProdModal('${p.id}')" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer hover:shadow-md transition">
                <div class="h-40 bg-gray-50"><img src="${(p.images||[])[0]}" class="w-full h-full object-cover mix-blend-multiply"></div>
                <div class="p-3">
                    <h4 class="font-bold text-sm truncate text-gray-800">${p.name}</h4>
                    <p class="font-black text-[#4b5f28] mt-1">${p.price} Ø¬.Ù…</p>
                </div>
            </div>
        `).join('');
    }

    window.openProdModal = function(id) {
        const p = window.allProducts.find(x => x.id === id);
        window.currentProd = p;
        window.selectedColor = null; window.selectedSize = null;
        
        document.getElementById('product-modal').classList.remove('hidden');
        document.getElementById('m-img').src = (p.images||[])[0];
        document.getElementById('m-name').innerText = p.name;
        document.getElementById('m-price').innerText = p.price + ' Ø¬.Ù…';
        
        // Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        const cWrap = document.getElementById('colors-area');
        const cDiv = document.getElementById('m-colors');
        if(p.colors && p.colors.length > 0) {
            cWrap.classList.remove('hidden');
            cDiv.innerHTML = p.colors.map(c => 
                `<button onclick="selColor('${c.name}', this)" class="px-3 py-1 border rounded-lg text-sm font-bold">${c.name}</button>`
            ).join('');
            document.getElementById('m-sizes').innerHTML = '<span class="text-gray-400 text-xs">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†..</span>';
        } else {
            cWrap.classList.add('hidden');
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£Ù„ÙˆØ§Ù†ØŒ Ø§Ø¹Ø±Ø¶ Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            // Ù„Ù„ØªØ¨Ø³ÙŠØ· Ù‡Ù†Ø¹ØªÙ…Ø¯ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¯Ø§ÙŠÙ…Ø§
        }
    }

    window.selColor = function(name, btn) {
        window.selectedColor = name;
        document.querySelectorAll('#m-colors button').forEach(b => b.classList.remove('bg-[#4b5f28]', 'text-white'));
        btn.classList.add('bg-[#4b5f28]', 'text-white');
        
        const colorData = window.currentProd.colors.find(c => c.name === name);
        document.getElementById('m-sizes').innerHTML = (colorData.sizes||[]).map(s => 
            `<button onclick="selSize('${s}', this)" class="w-8 h-8 rounded bg-gray-100 text-xs font-bold hover:bg-[#4b5f28] hover:text-white transition">${s}</button>`
        ).join('');
    }

    window.selSize = function(s, btn) {
        window.selectedSize = s;
        document.querySelectorAll('#m-sizes button').forEach(b => b.classList.remove('bg-[#4b5f28]', 'text-white'));
        btn.classList.add('bg-[#4b5f28]', 'text-white');
    }

    window.checkout = async function() {
        if(!window.cart || !window.cart.length) return toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©', 'error');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨
        if(!window.currentUser) {
            toast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø£ÙˆÙ„');
            closeCart();
            handleAuthClick();
            return;
        }

        const btn = document.querySelector('#cart-modal button:last-child');
        btn.disabled = true;
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

        try {
            const orderData = {
                items: window.cart,
                total: window.cart.reduce((s,i)=>s+(i.price*i.qty),0),
                customerName: window.currentUser.name,
                customerPhone: window.currentUser.phone,
                customerAddress: window.currentUser.address,
                timestamp: Date.now()
            };

            await addDoc(collection(db, "orders"), orderData);
            
            // Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨
            const msg = `ğŸ›’ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹*\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${window.currentUser.name}\nğŸ“: ${window.currentUser.phone}\nğŸ“: ${window.currentUser.address}\n\n` + 
                        window.cart.map(i => `- ${i.productName} (${i.color}/${i.size})`).join('\n') + 
                        `\n\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${orderData.total} Ø¬.Ù…`;
            
            window.open(`https://wa.me/201020468021?text=${encodeURIComponent(msg)}`, '_blank');
            
            window.cart = [];
            saveCart();
            renderCart();
            updateCartBadge();
            closeCart();
            toast('ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…');

        } catch(e) {
            console.error(e);
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
        btn.disabled = false;
        btn.innerText = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…';
    }

    window.goHome = () => {
        document.getElementById('products-view').classList.add('hidden');
        document.getElementById('home-view').classList.remove('hidden');
    }
    
    window.closeModal = () => document.getElementById('product-modal').classList.add('hidden');
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    updateUIForUser();
    
    // Toast Function
    function toast(msg, type='success') {
        const t = document.createElement('div');
        t.className = `bg-${type==='error'?'red':'green'}-600 text-white px-6 py-3 rounded-full font-bold shadow-xl mb-2 animate-bounce`;
        t.innerText = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
    window.toast = toast;
   </script>
 </body>
</html>
