<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ® - Ù„Ù„Ø£Ø­Ø°ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <script>tailwind.config = { theme: { extend: { colors: { brand: '#4b5f28' }, animation: { 'float': 'float 3s ease-in-out infinite' }, keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } } } } } }</script>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; -webkit-tap-highlight-color: transparent; }
    .scroll-hide::-webkit-scrollbar { display: none; }
    .heart-btn.active svg { fill: #ef4444; stroke: #ef4444; }
    .sale-tag { position: absolute; top: 10px; right: 10px; background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
    .st-new { background: #fef3c7; color: #92400e; } .st-processing { background: #dbeafe; color: #1e40af; } .st-shipped { background: #f3e8ff; color: #6b21a8; } .st-completed { background: #dcfce7; color: #166534; } .st-cancelled { background: #fee2e2; color: #991b1b; }
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù… */
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .page-enter { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  </style>
 </head>
 <body class="min-h-screen bg-gray-50 pb-24 relative overflow-x-hidden">
   
   <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[9999]"></div>

   <button onclick="openCart()" class="fixed bottom-20 left-4 z-40 w-14 h-14 bg-[#4b5f28] text-white rounded-full shadow-xl flex items-center justify-center animate-float border-2 border-white">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
     <span id="cart-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs font-bold flex items-center justify-center border border-white hidden">0</span>
   </button>

   <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 text-gray-400 text-xs font-bold shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
       <button onclick="switchView('home')" class="flex flex-col items-center gap-1 text-[#4b5f28] nav-btn" id="nav-home"><span class="text-xl">ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
       <button onclick="checkLoginAndAction('wishlist')" class="flex flex-col items-center gap-1 hover:text-[#4b5f28] nav-btn" id="nav-wishlist"><span class="text-xl">â¤ï¸</span>Ø§Ù„Ù…ÙØ¶Ù„Ø©</button>
       <button onclick="checkLoginAndAction('orders')" class="flex flex-col items-center gap-1 hover:text-[#4b5f28] nav-btn" id="nav-orders"><span class="text-xl">ğŸ“¦</span>Ø·Ù„Ø¨Ø§ØªÙŠ</button>
       <button onclick="openProfileEdit()" class="flex flex-col items-center gap-1 hover:text-[#4b5f28] nav-btn" id="nav-profile"><span class="text-xl">ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</button>
   </div>

   <div id="view-home" class="view-section max-w-md mx-auto">
     <div class="bg-white p-4 pb-2 shadow-sm rounded-b-3xl mb-6">
        <div class="flex justify-between items-center mb-4">
            <div><p class="text-xs text-gray-400 font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</p><h1 class="text-xl font-black text-gray-800" id="header-username">Ø²Ø§Ø¦Ø±</h1></div>
            <img onclick="openProfileEdit()" id="header-avatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-12 h-12 rounded-full border-2 border-gray-100 shadow-sm object-cover cursor-pointer">
        </div>
        <div id="banners-container" class="hidden"><div id="banners-slider" class="flex overflow-x-auto gap-3 snap-x scroll-hide pb-2 h-40"></div></div>
     </div>

     <div class="px-4 space-y-4 mb-6">
       <div onclick="openCategoryPage('Ø±Ø¬Ø§Ù„ÙŠ')" class="relative h-40 rounded-2xl overflow-hidden cursor-pointer shadow-lg group transform transition active:scale-95">
           <img src="men.jpg" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x150?text=Men'">
           <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-3xl font-black border-b-2 border-white/50 pb-1">Ø±Ø¬Ø§Ù„ÙŠ</h3></div>
       </div>
       <div onclick="openCategoryPage('Ø­Ø±ÙŠÙ…ÙŠ')" class="relative h-40 rounded-2xl overflow-hidden cursor-pointer shadow-lg group transform transition active:scale-95">
           <img src="women.jpg" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x150?text=Women'">
           <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-3xl font-black border-b-2 border-white/50 pb-1">Ø­Ø±ÙŠÙ…ÙŠ</h3></div>
       </div>
       <div onclick="openCategoryPage('Ø£Ø·ÙØ§Ù„ÙŠ')" class="relative h-40 rounded-2xl overflow-hidden cursor-pointer shadow-lg group transform transition active:scale-95">
           <img src="kids.jpg" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x150?text=Kids'">
           <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h3 class="text-white text-3xl font-black border-b-2 border-white/50 pb-1">Ø£Ø·ÙØ§Ù„ÙŠ</h3></div>
       </div>
     </div>
   </div>

   <div id="view-category" class="view-section hidden max-w-md mx-auto bg-gray-50 min-h-screen pb-24 absolute inset-0 z-20">
       <div class="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-30">
           <button onclick="goBackToHome()" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-700 hover:bg-gray-200 transition">â”</button>
           <h2 id="cat-page-title" class="text-xl font-black text-[#4b5f28]"></h2>
       </div>
       <div id="products-grid" class="grid grid-cols-2 gap-3 px-4 pt-6 pb-8"></div>
   </div>

   <div id="view-wishlist" class="view-section hidden max-w-md mx-auto pt-4 px-4">
       <h2 class="text-xl font-black text-[#4b5f28] mb-4 border-b pb-2">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</h2>
       <div id="wishlist-grid" class="grid grid-cols-2 gap-3"></div>
       <div id="wishlist-empty" class="hidden text-center py-20 text-gray-400">Ù„Ù… ØªØ­ÙØ¸ Ø´ÙŠØ¦Ø§Ù‹ Ø¨Ø¹Ø¯</div>
   </div>

   <div id="view-orders" class="view-section hidden max-w-md mx-auto pt-4 px-4">
       <h2 class="text-xl font-black text-[#4b5f28] mb-4 border-b pb-2">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
       <div id="orders-list" class="space-y-3"></div>
   </div>

   <div id="product-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4">
     <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl overflow-hidden max-h-[90vh] flex flex-col transform transition-transform duration-300 translate-y-full" id="modal-content">
       <button onclick="closeModal()" class="absolute top-4 left-4 z-10 w-8 h-8 bg-white/80 rounded-full font-bold shadow-sm text-gray-800">âœ•</button>
       <div class="h-64 bg-gray-100 p-4 relative">
           <img id="m-img" class="w-full h-full object-contain mix-blend-multiply">
           <span id="m-sale-badge" class="sale-tag hidden">SALE</span>
       </div>
       <div class="p-6 space-y-4 bg-white flex-1 overflow-y-auto">
         <div class="flex justify-between"><h2 id="m-name" class="text-xl font-bold"></h2><div class="text-right"><span id="m-price" class="text-xl font-black text-[#4b5f28]"></span><br><span id="m-old-price" class="text-sm text-gray-400 line-through hidden"></span></div></div>
         <div id="m-colors-wrap"><p class="text-xs text-gray-400 mb-2">Ø§Ù„Ù„ÙˆÙ†</p><div id="m-colors" class="flex flex-wrap gap-2"></div></div>
         <div id="m-sizes-wrap"><p class="text-xs text-gray-400 mb-2">Ø§Ù„Ù…Ù‚Ø§Ø³</p><div id="m-sizes" class="flex flex-wrap gap-2"></div></div>
         <button onclick="addToCart()" class="w-full py-3.5 bg-[#4b5f28] text-white font-bold rounded-xl shadow-lg mt-2 active:scale-95 transition">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’</button>
       </div>
     </div>
   </div>

   <div id="login-modal" class="hidden fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
       <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
           <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="absolute top-3 left-3 text-gray-400 text-xl">âœ•</button>
           <h3 class="text-xl font-bold text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
           <form onsubmit="handleLogin(event)" class="space-y-4">
               <input type="tel" id="l-phone" class="w-full p-3 border rounded-xl font-bold text-center text-lg focus:border-[#4b5f28] outline-none" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
               <div id="new-user-fields" class="hidden space-y-3">
                   <p class="text-xs text-green-600 text-center font-bold">Ø£ÙˆÙ„ Ù…Ø±Ø© Ù…Ù†ÙˆØ±Ù†Ø§! ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø·Ù„Ø¨</p>
                   <input id="l-name" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-[#4b5f28]" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                   <input id="l-address" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-[#4b5f28]" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
               </div>
               <button type="submit" id="l-btn" class="w-full py-3 bg-[#4b5f28] text-white font-bold rounded-xl">Ù…ØªØ§Ø¨Ø¹Ø© â”</button>
           </form>
       </div>
   </div>

   <div id="profile-modal" class="hidden fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
       <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
           <h3 class="font-bold text-lg mb-4 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ÙŠ</h3>
           <div class="space-y-3">
               <div class="flex justify-center mb-4">
                   <div class="relative w-24 h-24 cursor-pointer group" onclick="document.getElementById('avatar-file').click()">
                       <img id="edit-avatar-preview" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full rounded-full border-2 border-dashed border-[#4b5f28] p-1 object-cover">
                       <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><span class="text-white text-xs font-bold">ØªØºÙŠÙŠØ± ğŸ“·</span></div>
                       <input type="file" id="avatar-file" hidden accept="image/*" onchange="handleAvatarUpload(this)">
                   </div>
               </div>
               <input id="edit-name" class="w-full p-3 border rounded-xl text-sm focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ø§Ø³Ù…">
               <input id="edit-address" class="w-full p-3 border rounded-xl text-sm focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
               <button onclick="saveProfile()" id="save-profile-btn" class="w-full py-3 bg-[#4b5f28] text-white font-bold rounded-xl">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
               <button onclick="logout()" class="w-full py-2 text-red-500 font-bold text-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
               <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="w-full py-2 text-gray-400 text-sm">Ø¥Ù„ØºØ§Ø¡</button>
           </div>
       </div>
   </div>

   <div id="cart-modal" class="hidden fixed inset-0 z-[60] bg-black/50 flex justify-end">
     <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl" style="animation: slideLeft 0.3s">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h2 class="font-bold text-lg">ğŸ›’ Ø§Ù„Ø³Ù„Ø©</h2><button onclick="closeCart()" class="text-gray-500 font-bold text-xl">âœ•</button></div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div class="p-4 border-t bg-gray-50">
            <div class="mb-4 bg-white p-3 rounded-xl border shadow-sm">
                <p class="text-xs font-bold text-gray-500 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</p>
                <div class="space-y-2">
                    <input id="cart-name" class="w-full p-2 border rounded text-sm font-bold focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input id="cart-phone" class="w-full p-2 border rounded text-sm font-bold focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
                    <input id="cart-address" class="w-full p-2 border rounded text-sm font-bold focus:border-[#4b5f28] outline-none" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
                </div>
            </div>
            <div class="flex justify-between font-bold text-lg mb-4"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span id="cart-total" class="text-[#4b5f28]">0 Ø¬.Ù…</span></div>
            <button onclick="confirmOrder()" class="w-full py-4 bg-[#4b5f28] text-white font-bold rounded-xl shadow-lg">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
        </div>
     </div>
   </div>

   <script src="card.js"></script>
   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, setDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs", authDomain: "ahmed-shoes.firebaseapp.com", projectId: "ahmed-shoes", storageBucket: "ahmed-shoes.firebasestorage.app", messagingSenderId: "172928088473", appId: "1:172928088473:web:100f543fd097a8d5c33b08" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.currentUser = JSON.parse(localStorage.getItem('userData')) || null;
    window.products = []; window.wishlist = []; window.newAvatarBase64 = null;

    async function init() {
        // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if(window.currentUser) {
            document.getElementById('header-username').innerText = window.currentUser.name.split(' ')[0]; // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø­Ù…Ø©
            if(window.currentUser.avatar) document.getElementById('header-avatar').src = window.currentUser.avatar;
            try { const uSnap = await getDoc(doc(db, "users", window.currentUser.phone)); if(uSnap.exists() && uSnap.data().wishlist) window.wishlist = uSnap.data().wishlist; } catch(e){}
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        const qP = query(collection(db, "products"), orderBy("timestamp", "desc"));
        const snapP = await getDocs(qP);
        window.products = snapP.docs.map(d => ({id: d.id, ...d.data()}));

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ø§Ù„Ø¨Ù†Ø±Ø§Øª)
        const qB = query(collection(db, "banners"), orderBy("timestamp", "desc"));
        const snapB = await getDocs(qB);
        if(!snapB.empty) { 
            document.getElementById('banners-container').classList.remove('hidden'); 
            document.getElementById('banners-slider').innerHTML = snapB.docs.map(d => `<img src="${d.data().image}" class="h-full w-auto rounded-xl object-cover snap-center shadow-sm">`).join(''); 
        } else { 
            document.getElementById('banners-container').classList.add('hidden'); 
        }
    }
    init();

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ---
    window.switchView = (v) => {
        document.querySelectorAll('.view-section').forEach(e => {
            e.classList.add('hidden');
            e.classList.remove('page-enter'); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…
        });
        
        const targetView = document.getElementById('view-'+v);
        targetView.classList.remove('hidden');
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù„ÙŠ Ù…Ø­ØªØ§Ø¬Ø§Ù‡
        if(v !== 'home') targetView.classList.add('page-enter');

        // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-[#4b5f28]'));
        document.getElementById('nav-'+v)?.classList.add('text-[#4b5f28]');
        
        window.scrollTo(0,0);
    };

    // --- ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù… (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
    window.openCategoryPage = (cat) => {
        document.getElementById('cat-page-title').innerText = cat;
        
        // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø­Ø§Ø¬Ø© ÙˆÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù… Ø¨Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        const catView = document.getElementById('view-category');
        catView.classList.remove('hidden');
        
        // ØªØ±Ø³Øª Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        catView.classList.remove('page-enter');
        void catView.offsetWidth; 
        catView.classList.add('page-enter');

        renderGrid(window.products.filter(p=>p.category===cat));
        window.scrollTo(0,0);
    };

    window.goBackToHome = () => {
        switchView('home');
    };

    // --- Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function renderGrid(items) {
        const grid = document.getElementById('products-grid');
        if(items.length === 0) { grid.innerHTML = '<p class="col-span-2 text-center text-gray-400 py-20 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</p>'; return; }
        
        grid.innerHTML = items.map(p => {
            const isLiked = window.wishlist.includes(p.id);
            const hasSale = p.oldPrice && p.oldPrice > p.price;
            const saleHtml = hasSale ? `<span class="sale-tag">SALE</span>` : '';
            const priceHtml = hasSale ? `<div class="flex flex-col items-start"><span class="text-xs text-gray-400 line-through decoration-red-500">${p.oldPrice}</span><span class="font-black text-[#4b5f28]">${p.price} Ø¬.Ù…</span></div>` : `<p class="font-black text-[#4b5f28]">${p.price} Ø¬.Ù…</p>`;

            return `<div class="bg-white rounded-xl shadow-sm border overflow-hidden relative group">
                ${saleHtml}
                <button onclick="toggleWish('${p.id}', this)" class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center z-10 shadow-sm heart-btn ${isLiked?'active':''}"><svg class="w-5 h-5 transition stroke-gray-400 ${isLiked?'fill-red-500 stroke-red-500':''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button>
                <div onclick="openProd('${p.id}')" class="h-40 bg-gray-50"><img src="${p.images[0]}" class="w-full h-full object-cover mix-blend-multiply"></div>
                <div onclick="openProd('${p.id}')" class="p-3"><h4 class="font-bold text-sm truncate text-gray-800">${p.name}</h4><div class="mt-1">${priceHtml}</div></div>
            </div>`;
        }).join('');
    }

    // --- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ ---
    window.openProd = (id) => {
        const p = window.products.find(x=>x.id===id); window.currentProd=p; window.selColorVar=null; window.selSizeVar=null;
        const modalContent = document.getElementById('modal-content');
        document.getElementById('product-modal').classList.remove('hidden');
        setTimeout(() => modalContent.classList.remove('translate-y-full'), 10);

        document.getElementById('m-img').src=p.images[0];
        document.getElementById('m-name').innerText=p.name;
        document.getElementById('m-price').innerText=p.price+' Ø¬.Ù…';
        
        if(p.oldPrice && p.oldPrice > p.price) { 
            document.getElementById('m-old-price').innerText=p.oldPrice+' Ø¬.Ù…'; document.getElementById('m-old-price').classList.remove('hidden'); 
            document.getElementById('m-sale-badge').classList.remove('hidden');
        } else { 
            document.getElementById('m-old-price').classList.add('hidden');
            document.getElementById('m-sale-badge').classList.add('hidden');
        }

        document.getElementById('m-colors').innerHTML = p.colors.map(c=>`<button onclick="selColor('${c.name}',this)" class="px-4 py-2 border border-gray-200 rounded-lg font-bold text-sm text-gray-700">${c.name}</button>`).join('');
        document.getElementById('m-sizes').innerHTML = '<span class="text-xs text-gray-400">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹</span>';
    };
    window.closeModal = () => { const modalContent = document.getElementById('modal-content'); modalContent.classList.add('translate-y-full'); setTimeout(() => document.getElementById('product-modal').classList.add('hidden'), 300); }

    // --- Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ ---
    window.toggleWish = async (id, btn) => { event.stopPropagation(); if(!window.currentUser) return toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'error'); if(window.wishlist.includes(id)) window.wishlist = window.wishlist.filter(x=>x!==id); else window.wishlist.push(id); btn.classList.toggle('active'); btn.querySelector('svg').classList.toggle('fill-red-500'); btn.querySelector('svg').classList.toggle('stroke-red-500'); await updateDoc(doc(db, "users", window.currentUser.phone), { wishlist: window.wishlist }); };
    window.openWishlist = () => { const items = window.products.filter(p => window.wishlist.includes(p.id)); document.getElementById('wishlist-grid').innerHTML = items.length ? items.map(p => { const hasSale = p.oldPrice && p.oldPrice > p.price; return `<div class="bg-white rounded-xl p-3 border shadow-sm flex gap-3 items-center relative"><button onclick="toggleWish('${p.id}', this.parentElement)" class="absolute top-2 left-2 text-red-500 text-xs font-bold bg-red-50 px-2 py-1 rounded">âœ•</button><img src="${p.images[0]}" class="w-20 h-20 rounded-lg object-cover bg-gray-50"><div class="flex-1"><h4 class="font-bold text-sm text-gray-800">${p.name}</h4><div class="flex flex-col"><span class="font-black text-[#4b5f28]">${p.price} Ø¬.Ù…</span>${hasSale?`<span class="text-xs text-red-500 line-through">${p.oldPrice}</span>`:''}</div><button onclick="openProd('${p.id}')" class="bg-[#4b5f28] text-white px-4 py-1.5 rounded-lg text-xs font-bold mt-2">Ø´Ø±Ø§Ø¡ ğŸ›’</button></div></div>`; }).join('') : '<div class="col-span-2 text-center text-gray-400 py-20"><div class="text-5xl mb-2 opacity-50">ğŸ’”</div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>'; };

    window.checkLoginAndAction = (act) => { if(!window.currentUser) { window.pendingAction=act; document.getElementById('login-modal').classList.remove('hidden'); } else { switchView(act); if(act==='orders') loadOrders(); if(act==='wishlist') openWishlist(); } };
    window.handleLogin = async (e) => { e.preventDefault(); const ph=document.getElementById('l-phone').value.trim(), btn=document.getElementById('l-btn'), newF=document.getElementById('new-user-fields'); btn.disabled=true; try { const ref = doc(db, "users", ph); const snap = await getDoc(ref); if(snap.exists()) finishLogin(snap.data()); else { if(newF.classList.contains('hidden')) { newF.classList.remove('hidden'); btn.innerText='ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸'; btn.disabled=false; } else { const u={name:document.getElementById('l-name').value, address:document.getElementById('l-address').value, phone:ph, wishlist:[]}; await setDoc(ref, u); finishLogin(u); } } } catch(e) { alert('Ø®Ø·Ø£'); btn.disabled=false; } };
    function finishLogin(u) { localStorage.setItem('userData', JSON.stringify(u)); window.currentUser=u; window.wishlist=u.wishlist||[]; document.getElementById('header-username').innerText=u.name.split(' ')[0]; if(u.avatar)document.getElementById('header-avatar').src=u.avatar; document.getElementById('login-modal').classList.add('hidden'); if(window.pendingAction){ switchView(window.pendingAction); if(window.pendingAction==='orders')loadOrders(); if(window.pendingAction==='wishlist')openWishlist(); } }
    
    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
    const compress = (f) => new Promise(res => { const r = new FileReader(); r.readAsDataURL(f); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=300/i.width; c.width=300; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); res(c.toDataURL('image/jpeg',0.7)); } } });
    window.handleAvatarUpload = async (inp) => { if(inp.files[0]) { const b64 = await compress(inp.files[0]); document.getElementById('edit-avatar-preview').src = b64; window.newAvatarBase64 = b64; } };

    window.openProfileEdit = () => { if(!window.currentUser) return checkLoginAndAction('home'); document.getElementById('profile-modal').classList.remove('hidden'); document.getElementById('edit-name').value=window.currentUser.name; document.getElementById('edit-address').value=window.currentUser.address; if(window.currentUser.avatar) document.getElementById('edit-avatar-preview').src=window.currentUser.avatar; };
    window.saveProfile = async () => { const n=document.getElementById('edit-name').value, a=document.getElementById('edit-address').value; const btn = document.getElementById('save-profile-btn'); btn.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled=true; const up={name:n, address:a}; if(window.newAvatarBase64) up.avatar = window.newAvatarBase64; await updateDoc(doc(db,"users",window.currentUser.phone),up); window.currentUser={...window.currentUser,...up}; localStorage.setItem('userData',JSON.stringify(window.currentUser)); document.getElementById('header-username').innerText=n.split(' ')[0]; if(up.avatar) document.getElementById('header-avatar').src=up.avatar; document.getElementById('profile-modal').classList.add('hidden'); btn.innerText="Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"; btn.disabled=false; toast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ âœ…'); };
    window.logout = () => { localStorage.removeItem('userData'); location.reload(); };

    // --- Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¹Ù…Ù„ 100%) ---
    async function loadOrders() {
        document.getElementById('orders-list').innerHTML='<p class="text-center py-10 text-2xl animate-spin">â³</p>';
        // Ø¨Ù†Ø³Ø­Ø¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ÙŠÙˆØ²Ø± Ø¯Ù‡ Ø¨Ø³ ÙˆØ¨Ù†Ø±ØªØ¨Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø¹Ø´Ø§Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù…ÙŠØ¹Ù…Ù„Ø´ Ø§ÙŠØ±ÙˆØ± Ø§Ù„Ù€ Index
        const q=query(collection(db,"orders"),where("customerPhone","==",window.currentUser.phone)); 
        const snap=await getDocs(q);
        if(snap.empty){ document.getElementById('orders-list').innerHTML='<div class="text-center py-20"><div class="text-6xl mb-4 opacity-50">ğŸ“¦</div><p class="text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p></div>'; return; }
        
        const orders = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
        const stText={'new':'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','processing':'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²','shipped':'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚','completed':'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…','cancelled':'Ù…Ù„ØºÙŠ'};
        const stCls={'new':'st-new','processing':'st-processing','shipped':'st-shipped','completed':'st-completed','cancelled':'st-cancelled'};
        
        document.getElementById('orders-list').innerHTML=orders.map(o=>{ const st=o.status||'new'; return `<div class="bg-white p-4 rounded-xl border shadow-sm"><div class="flex justify-between mb-3 border-b pb-2"><span class="font-bold text-gray-800">#${o.id.slice(0,6).toUpperCase()}</span><span class="status-badge px-2 py-1 rounded-full text-xs font-bold ${stCls[st]}">${stText[st]}</span></div><div class="text-sm text-gray-600 mb-3 bg-gray-50 p-2 rounded">${o.items.map(i=>`<p>â€¢ ${i.productName} (${i.color}/${i.size}) Ã— ${i.qty}</p>`).join('')}</div><div class="flex justify-between items-center pt-2"><span class="text-xs text-gray-400 font-bold">${new Date(o.timestamp).toLocaleDateString('ar-EG')}</span><span class="font-black text-[#4b5f28] text-lg">${o.total} Ø¬.Ù…</span></div></div>`; }).join('');
    }

    // --- Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª ---
    window.selColor = (n,btn) => { window.selColorVar=n; document.querySelectorAll('#m-colors button').forEach(b=>b.classList.remove('bg-[#4b5f28]','text-white')); btn.classList.add('bg-[#4b5f28]','text-white'); const sizes = window.currentProd.colors.find(c=>c.name===n).sizes; document.getElementById('m-sizes').innerHTML = sizes.map(s=>`<button onclick="selSize('${s}',this)" class="w-10 h-10 bg-gray-100 rounded-lg font-bold text-gray-700 hover:bg-[#4b5f28] hover:text-white transition">${s}</button>`).join(''); };
    window.selSize = (s,btn) => { window.selSizeVar=s; document.querySelectorAll('#m-sizes button').forEach(b=>b.classList.remove('bg-[#4b5f28]','text-white')); btn.classList.add('bg-[#4b5f28]','text-white'); };
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨
    window.confirmOrder = async () => {
        if(!window.cart?.length) return alert('Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©');
        if(!window.currentUser) { closeCart(); return checkLoginAndAction('home'); }
        const name = document.getElementById('cart-name').value; const phone = document.getElementById('cart-phone').value; const address = document.getElementById('cart-address').value;
        if(!name || !phone || !address) return toast('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†', 'error');

        const btn=document.querySelector('#cart-modal button:last-child'); btn.disabled=true; btn.innerText='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø±Ø³Ø§Ù„...';
        try { 
            const docRef = await addDoc(collection(db,"orders"),{ items:window.cart, total:window.cart.reduce((s,i)=>s+(i.price*i.qty),0), customerName: name, customerPhone: phone, customerAddress: address, timestamp:Date.now(), status:'new' }); 
            const orderId = docRef.id.slice(-6).toUpperCase();
            
            // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
            const msg = `ğŸ›’ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯*\nğŸ‘¤ ${name}\nğŸ“ ${phone}\nğŸ“ ${address}\n\n` + window.cart.map(i=>`- ${i.productName} (${i.color}/${i.size}) Ã— ${i.qty}`).join('\n') + `\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${window.cart.reduce((s,i)=>s+(i.price*i.qty),0)} Ø¬.Ù…`;
            window.open(`https://wa.me/201020468021?text=${encodeURIComponent(msg)}`, '_blank');

            window.cart=[]; saveCart(); renderCart(); updateCartBadge(); closeCart(); 
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            document.getElementById('order-number-display').innerText = '#' + orderId;
            document.getElementById('order-success-modal').classList.remove('hidden');
        } catch(e){ toast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'); } 
        btn.disabled=false; btn.innerText='ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…';
    };
    
    window.toast=(m,t)=>{const e=document.createElement('div');e.className=`bg-${t=='error'?'red':'green'}-600 text-white px-6 py-3 rounded-full font-bold shadow-xl mb-2 animate-bounce`;e.innerText=m;document.getElementById('toast-container').appendChild(e);setTimeout(()=>e.remove(),3000)};
   </script>
 </body>
</html>
