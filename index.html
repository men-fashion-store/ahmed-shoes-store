<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4b5f28">
  <title>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</title> <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          colors: { brand: { light: '#F3F4F6', DEFAULT: '#4b5f28', text: '#2d3748', accent: '#708238' } },
          animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
          keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
        } 
      } 
    }
  </script>
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }
    .glass-panel { background: rgba(255,255,255,0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.5); }
    .loader { border-top-color: #4b5f28; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
    @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
    .product-card { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s; }
    .product-card:active { transform: scale(0.98); }
    
    /* Ø²Ø± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
    .floating-cart { position: fixed; bottom: 30px; left: 30px; z-index: 50; animation: float 3s ease-in-out infinite; box-shadow: 0 10px 25px -5px rgba(75, 95, 40, 0.4); }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù€ reCAPTCHA (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø±Ø¦ÙŠØ© Ù„ØªØ¹Ù…Ù„) */
    #recaptcha-container { margin-bottom: 10px; display: flex; justify-content: center; }
  </style>
 </head>
 <body class="h-full min-h-screen">
   <div id="toast-container"></div>

   <div id="app-loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
       <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
       <p class="text-gray-500 text-sm font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...</p>
   </div>

   <button onclick="openCart()" class="floating-cart w-16 h-16 bg-[#4b5f28] text-white rounded-full flex items-center justify-center border-4 border-white/80 backdrop-blur-sm group hover:scale-110 transition">
     <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
     <span id="cart-badge" class="absolute -top-1 -right-1 w-6 h-6 bg-red-600 rounded-full text-white text-xs font-bold flex items-center justify-center border-2 border-white hidden">0</span>
   </button>

   <div class="fixed top-0 left-0 w-full z-40 px-4 py-3 flex justify-between items-center pointer-events-none">
       <button onclick="toggleDark()" class="pointer-events-auto w-10 h-10 rounded-full bg-white/90 backdrop-blur shadow-sm flex items-center justify-center text-gray-600 hover:bg-gray-100 transition">ğŸŒ™</button>
       <div id="user-status" class="pointer-events-auto transition-all duration-300">
           </div>
   </div>

   <div id="home-view" class="relative max-w-md mx-auto px-6 py-12 min-h-screen flex flex-col items-center pt-24 animate-fade-in">
     <div class="text-center mb-10 w-full">
        <div class="w-32 h-32 mx-auto rounded-full bg-white p-2 shadow-xl mb-4 relative overflow-hidden ring-4 ring-white">
            <img id="store-logo" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-contain" alt="Store Logo">
        </div>
        <h1 id="store-name" class="text-3xl font-black text-[#4b5f28] mb-1">...</h1>
        <p class="text-gray-400 font-bold text-xs tracking-[0.2em] uppercase">OFFICIAL STORE</p>
     </div>

     <div class="w-full space-y-4">
       <button onclick="showCategory('Ø±Ø¬Ø§Ù„ÙŠ')" class="w-full bg-white/60 backdrop-blur-md p-4 rounded-2xl border border-white shadow-sm hover:shadow-md transition flex items-center gap-4 group">
         <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-2xl">ğŸ‘</div>
         <h3 class="flex-1 text-right font-bold text-gray-700 text-lg group-hover:text-[#4b5f28] transition">Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„</h3>
         <span class="text-gray-300 group-hover:translate-x-[-5px] transition">â†</span>
       </button>
       <button onclick="showCategory('Ø­Ø±ÙŠÙ…ÙŠ')" class="w-full bg-white/60 backdrop-blur-md p-4 rounded-2xl border border-white shadow-sm hover:shadow-md transition flex items-center gap-4 group">
         <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-2xl">ğŸ‘ </div>
         <h3 class="flex-1 text-right font-bold text-gray-700 text-lg group-hover:text-[#4b5f28] transition">Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡</h3>
         <span class="text-gray-300 group-hover:translate-x-[-5px] transition">â†</span>
       </button>
       <button onclick="showCategory('Ø£Ø·ÙØ§Ù„ÙŠ')" class="w-full bg-white/60 backdrop-blur-md p-4 rounded-2xl border border-white shadow-sm hover:shadow-md transition flex items-center gap-4 group">
         <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-2xl">ğŸ‘Ÿ</div>
         <h3 class="flex-1 text-right font-bold text-gray-700 text-lg group-hover:text-[#4b5f28] transition">Ù‚Ø³Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„</h3>
         <span class="text-gray-300 group-hover:translate-x-[-5px] transition">â†</span>
       </button>
     </div>
   </div>

   <div id="products-view" class="hidden max-w-6xl mx-auto px-4 py-6 min-h-screen pt-24 animate-fade-in">
     <div class="bg-white/80 backdrop-blur-xl px-4 py-3 rounded-2xl sticky top-20 z-30 flex justify-between items-center mb-6 shadow-sm border border-gray-100">
       <div class="flex items-center gap-3">
           <button onclick="goHome()" class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center font-bold text-gray-600 transition">â†</button>
           <h3 id="cat-title" class="text-xl font-bold text-[#4b5f28]"></h3>
       </div>
     </div>
     <div id="grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-20"></div>
   </div>

   <div id="modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
     <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl animate-fade-in">
       <div class="relative bg-gray-50 h-72 flex items-center justify-center">
         <button onclick="closeModal()" class="absolute top-4 left-4 w-10 h-10 bg-white/80 rounded-full shadow-sm text-gray-600 font-bold z-10 hover:text-red-500">âœ•</button>
         <img id="main-img" class="max-h-full max-w-full object-contain mix-blend-multiply p-4">
       </div>
       <div class="p-6">
         <div class="flex justify-between items-start mb-4">
             <h2 id="m-name" class="text-2xl font-black text-gray-800"></h2>
             <p id="m-price" class="text-2xl font-black text-[#4b5f28]"></p>
         </div>
         <div id="m-colors-wrap" class="mb-4">
             <p class="text-xs text-gray-400 font-bold mb-2 uppercase">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†</p>
             <div id="m-colors" class="flex flex-wrap gap-2"></div>
         </div>
         <div class="mb-8">
             <p class="text-xs text-gray-400 font-bold mb-2 uppercase">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³</p>
             <div id="m-sizes" class="flex flex-wrap gap-2"></div>
         </div>
         <button onclick="addToCart()" class="w-full py-4 rounded-xl bg-[#4b5f28] text-white font-bold text-lg hover:bg-[#3a4a1f] transition shadow-lg shadow-[#4b5f28]/20">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
       </div>
     </div>
   </div>

   <div id="auth-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
       <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl relative">
           <button onclick="closeAuthModal()" class="absolute top-4 left-4 text-gray-300 hover:text-gray-500">âœ•</button>
           
           <div id="step-phone">
               <h2 class="text-2xl font-black text-center mb-2 text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”</h2>
               <p class="text-center text-gray-400 text-sm mb-6">Ø³Ø¬Ù„ Ø¨Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„ØªØ£ÙƒÙŠØ¯ Ù‡ÙˆÙŠØªÙƒ ÙˆØ­ÙØ¸ Ø·Ù„Ø¨Ø§ØªÙƒ</p>
               
               <div class="mb-4">
                   <label class="block text-xs font-bold text-gray-500 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                   <div class="flex gap-2" dir="ltr">
                       <span class="px-3 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold border border-transparent">+20</span>
                       <input id="phone-number" type="tel" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold text-gray-800 outline-none focus:border-[#4b5f28] transition text-left" placeholder="1xxxxxxxxx">
                   </div>
               </div>
               <div id="recaptcha-container"></div>
               
               <button onclick="sendOTP()" id="send-otp-btn" class="w-full py-3 rounded-xl bg-[#4b5f28] text-white font-bold hover:opacity-90 transition shadow-lg shadow-[#4b5f28]/20">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
           </div>

           <div id="step-otp" class="hidden">
               <h2 class="text-2xl font-black text-center mb-2 text-gray-800">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² ğŸ’¬</h2>
               <p class="text-center text-gray-400 text-sm mb-6">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…</p>
               
               <input id="otp-code" type="text" maxlength="6" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold text-center text-2xl tracking-widest text-gray-800 outline-none focus:border-[#4b5f28] mb-4 transition">
               
               <button onclick="verifyOTP()" id="verify-btn" class="w-full py-3 rounded-xl bg-[#4b5f28] text-white font-bold hover:opacity-90 transition mb-3">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
               <button onclick="resetAuth()" class="w-full text-sm text-gray-400 hover:text-gray-600">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…</button>
           </div>
       </div>
   </div>

   <div id="cart-modal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex p-0 items-end sm:items-center sm:justify-center">
     <div class="modal-content bg-white w-full sm:max-w-md sm:rounded-2xl h-[90vh] sm:h-auto flex flex-col shadow-2xl">
       <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
         <h2 class="text-xl font-black text-gray-800">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
         <button onclick="closeCart()" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 hover:bg-red-100 hover:text-red-500 font-bold transition">âœ•</button>
       </div>
       
       <div id="cart-items" class="p-4 flex-1 overflow-y-auto bg-white space-y-3"></div>
       
       <div class="p-5 border-t border-gray-100 bg-gray-50/30 space-y-4">
         <div class="space-y-3">
             <div class="flex justify-between items-center">
                 <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</p>
                 <button onclick="openAuthModal()" id="login-hint" class="text-xs text-[#4b5f28] font-bold hover:underline hidden">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù†Ùƒ</button>
             </div>
             <input id="c-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full bg-white border border-gray-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-[#4b5f28] transition">
             <input id="c-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©)" class="w-full bg-white border border-gray-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-[#4b5f28] transition">
             </div>
         
         <div class="flex justify-between items-center py-2 border-t border-dashed border-gray-300">
             <span class="font-bold text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
             <span id="cart-total-confirm" class="text-2xl font-black text-[#4b5f28]">0 Ø¬.Ù…</span>
         </div>
         
         <button onclick="confirmOrder()" id="confirm-order-btn" class="w-full py-4 rounded-xl bg-gray-900 text-white font-bold text-lg hover:bg-black transition flex justify-center items-center gap-2">
           <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span>
           <span>ğŸš€</span>
         </button>
       </div>
     </div>
   </div>

   <div id="order-success-modal" class="hidden fixed inset-0 z-[70] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
     <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden">
       <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#4b5f28] to-[#708238]"></div>
       <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
           <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
       </div>
       <h3 class="text-2xl font-black text-gray-800 mb-2">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!</h3>
       <p class="text-gray-500 text-sm mb-6">Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
       <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
           <p class="text-xs text-gray-400 font-bold uppercase mb-1">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</p>
           <p id="order-number-display" class="text-3xl font-black text-[#4b5f28] font-mono tracking-widest">#0000</p>
       </div>
       <button onclick="closeOrderSuccess()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-700 font-bold hover:bg-gray-200 transition">Ø¥ØºÙ„Ø§Ù‚</button>
     </div>
   </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASO-AN5XaSGn4SaCZ8VlHr6zsFCIxPCzs",
      authDomain: "ahmed-shoes.firebaseapp.com",
      projectId: "ahmed-shoes",
      storageBucket: "ahmed-shoes.firebasestorage.app",
      messagingSenderId: "172928088473",
      appId: "1:172928088473:web:100f543fd097a8d5c33b08",
      measurementId: "G-S50TX0VMKE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    auth.languageCode = 'ar'; // Ù„ØºØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø±Ø¨ÙŠØ©

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let products = [];
    let currentUser = null;
    let confirmationResult = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù€ OTP
    window.cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ---
    window.addEventListener('DOMContentLoaded', async () => {
        setupRecaptcha(); // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù€ recaptcha
        await loadStoreSettings(); // Ø¬Ù„Ø¨ Ø§Ù„Ù„ÙˆØ¬Ùˆ ÙˆØ§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±
        document.getElementById('app-loader').classList.add('opacity-0');
        setTimeout(() => document.getElementById('app-loader').remove(), 500);
        updateCartBadge();
    });

    // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadStoreSettings() {
        try {
            const docRef = doc(db, "settings", "store_config");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.title = data.storeName || "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®";
                document.getElementById('store-name').textContent = data.storeName || "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®";
                if(data.logoUrl) document.getElementById('store-logo').src = data.logoUrl;
            } else {
                document.getElementById('store-name').textContent = "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                await setDoc(docRef, { storeName: "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®", logoUrl: "" });
            }
        } catch (e) {
            console.log("Offline or Config Error", e);
            document.getElementById('store-name').textContent = "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø´ÙŠØ®";
        }
    }

    // --- 2. Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù‡Ø§ØªÙ (OTP) ---
    function setupRecaptcha() {
        if(!window.recaptchaVerifier) {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'normal', // Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡Ø§ 'invisible' Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡Ø§ Ù…Ø®ÙÙŠØ©
                'callback': (response) => {
                    // ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚
                }
            });
            window.recaptchaVerifier.render();
        }
    }

    window.openAuthModal = function() {
        document.getElementById('auth-modal').classList.remove('hidden');
        resetAuth();
    }
    
    window.closeAuthModal = function() {
        document.getElementById('auth-modal').classList.add('hidden');
    }

    window.resetAuth = function() {
        document.getElementById('step-phone').classList.remove('hidden');
        document.getElementById('step-otp').classList.add('hidden');
        document.getElementById('otp-code').value = '';
    }

    window.sendOTP = async function() {
        const phoneInput = document.getElementById('phone-number').value;
        const btn = document.getElementById('send-otp-btn');
        
        if(!phoneInput || phoneInput.length !== 11) return toast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
        
        const phoneNumber = '+20' + phoneInput; // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù…ØµØ±
        
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        btn.disabled = true;

        try {
            const appVerifier = window.recaptchaVerifier;
            confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
            
            document.getElementById('step-phone').classList.add('hidden');
            document.getElementById('step-otp').classList.remove('hidden');
            toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ğŸ’¬');
        } catch (error) {
            console.error(error);
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø´Ø¨ÙƒØ©', 'error');
            window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
        }
        btn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚';
        btn.disabled = false;
    }

    window.verifyOTP = async function() {
        const code = document.getElementById('otp-code').value;
        const btn = document.getElementById('verify-btn');
        
        if(!code || code.length !== 6) return toast('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
        
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        btn.disabled = true;

        try {
            const result = await confirmationResult.confirm(code);
            const user = result.user;
            // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„
            closeAuthModal();
            toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰');
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø©
            checkAndSaveUser(user);
        } catch (error) {
            toast('Ø§Ù„ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦', 'error');
        }
        btn.innerText = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        btn.disabled = false;
    }

    async function checkAndSaveUser(user) {
        const userRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(userRef);
        if(!docSnap.exists()) {
            await setDoc(userRef, {
                phone: user.phoneNumber,
                createdAt: Date.now(),
                name: '', // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨
                address: ''
            });
        }
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, async (user) => {
        const statusDiv = document.getElementById('user-status');
        const loginHint = document.getElementById('login-hint');
        
        if (user) {
            currentUser = user;
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†)
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            
            statusDiv.innerHTML = `
                <button onclick="logout()" class="px-4 py-2 bg-red-50 text-red-600 rounded-full font-bold text-xs shadow-sm hover:bg-red-100 transition border border-red-100">
                    Ø®Ø±ÙˆØ¬ (${user.phoneNumber.slice(-4)}..)
                </button>
            `;
            
            // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if(userData.name) document.getElementById('c-name').value = userData.name;
            if(userData.address) document.getElementById('c-address').value = userData.address;
            
            if(loginHint) loginHint.classList.add('hidden');
        } else {
            currentUser = null;
            statusDiv.innerHTML = `
                <button onclick="openAuthModal()" class="px-4 py-2 bg-[#4b5f28] text-white rounded-full font-bold text-xs shadow-lg hover:bg-[#3a4a1f] transition border border-transparent">
                    Ø¯Ø®ÙˆÙ„ / Ø­Ø³Ø§Ø¨ ğŸ‘¤
                </button>
            `;
            if(loginHint) loginHint.classList.remove('hidden');
        }
    });

    window.logout = function() {
        signOut(auth).then(() => {
            toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
            document.getElementById('c-name').value = '';
            document.getElementById('c-address').value = '';
        });
    }

    // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

    function toast(msg, type='success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    window.toggleDark = function() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    };
    if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark');

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
    window.showCategory = async function(cat) {
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('products-view').classList.remove('hidden');
        document.getElementById('cat-title').innerText = cat;
        document.getElementById('loading-msg').classList.remove('hidden');
        document.getElementById('grid').innerHTML = '';

        try {
            const q = query(collection(db, "products"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            products = [];
            snapshot.forEach(doc => products.push({id: doc.id, ...doc.data()}));
            document.getElementById('loading-msg').classList.add('hidden');
            renderProductsGrid(products.filter(p => p.category === cat));
        } catch (error) {
            document.getElementById('loading-msg').innerText = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
        }
    }

    function renderProductsGrid(items) {
        const grid = document.getElementById('grid');
        if(!items.length) { grid.innerHTML = '<p class="text-center w-full col-span-4 text-gray-400 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>'; return; }
        
        grid.innerHTML = items.map(p => `
            <div onclick="openModal('${p.id}')" class="product-card bg-white rounded-2xl overflow-hidden cursor-pointer shadow-sm hover:shadow-xl border border-gray-100">
                <div class="h-40 bg-gray-50 relative"><img src="${(p.images||[])[0]}" class="w-full h-full object-cover mix-blend-multiply"></div>
                <div class="p-3">
                    <h4 class="font-bold text-sm truncate text-gray-800">${p.name}</h4>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-[#4b5f28] font-black text-sm">${p.price} Ø¬.Ù…</span>
                        <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 text-xs">+</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    window.goHome = function() {
        document.getElementById('products-view').classList.add('hidden');
        document.getElementById('home-view').classList.remove('hidden');
    }

    // Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
    window.openModal = function(id) {
        window.currentProd = products.find(p => p.id === id);
        window.currentSize = null; window.currentColor = null;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('m-name').innerText = window.currentProd.name;
        document.getElementById('m-price').innerText = window.currentProd.price + ' Ø¬.Ù…';
        document.getElementById('main-img').src = (window.currentProd.images||[])[0];
        
        // Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        const colors = window.currentProd.colors || [{name:'Ø§ÙØªØ±Ø§Ø¶ÙŠ', sizes: window.currentProd.sizes||[]}];
        document.getElementById('m-colors').innerHTML = colors.map((c, i) => 
            `<button onclick="selectColor('${c.name}', this)" class="px-3 py-1 rounded-lg border text-sm font-bold ${i===0?'border-[#4b5f28] text-[#4b5f28] bg-[#4b5f28]/10':''} transition">${c.name}</button>`
        ).join('');
        
        if(colors.length > 0) selectColor(colors[0].name, document.querySelector('#m-colors button'));
    }

    window.selectColor = function(name, btn) {
        window.currentColor = name; window.currentSize = null;
        document.querySelectorAll('#m-colors button').forEach(b => b.className = "px-3 py-1 rounded-lg border text-sm font-bold text-gray-500 border-gray-200");
        btn.className = "px-3 py-1 rounded-lg border border-[#4b5f28] text-[#4b5f28] bg-[#4b5f28]/10 text-sm font-bold";
        
        const colorData = window.currentProd.colors ? window.currentProd.colors.find(c=>c.name===name) : {sizes: window.currentProd.sizes};
        document.getElementById('m-sizes').innerHTML = (colorData.sizes||[]).map(s => 
            `<button onclick="selectSize('${s}', this)" class="w-8 h-8 rounded-lg border flex items-center justify-center text-xs font-bold text-gray-500 hover:border-[#4b5f28] transition">${s}</button>`
        ).join('');
    }

    window.selectSize = function(s, btn) {
        window.currentSize = s;
        document.querySelectorAll('#m-sizes button').forEach(b => b.className = "w-8 h-8 rounded-lg border flex items-center justify-center text-xs font-bold text-gray-500 border-gray-200");
        btn.className = "w-8 h-8 rounded-lg border bg-[#4b5f28] text-white border-[#4b5f28] flex items-center justify-center text-xs font-bold shadow-md";
    }

    window.addToCart = function() {
        if(!window.currentSize) return toast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        window.cart.push({
            cartId: Date.now() + Math.random().toString(36).substr(2, 9),
            ...window.currentProd,
            color: window.currentColor,
            size: window.currentSize,
            qty: 1,
            price: parseInt(window.currentProd.price)
        });
        updateCartBadge();
        localStorage.setItem('cart', JSON.stringify(window.cart));
        closeModal();
        toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
    }

    window.closeModal = function() { document.getElementById('modal').classList.add('hidden'); }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø©
    window.openCart = function() { renderCart(); document.getElementById('cart-modal').classList.remove('hidden'); }
    window.closeCart = function() { document.getElementById('cart-modal').classList.add('hidden'); }
    window.clearCart = function() { 
        if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©ØŸ')) { window.cart = []; updateCartBadge(); localStorage.setItem('cart', '[]'); renderCart(); }
    }

    window.updateQty = function(id, delta) {
        const item = window.cart.find(i => i.cartId === id);
        if(item) {
            item.qty += delta;
            if(item.qty < 1) window.cart = window.cart.filter(i => i.cartId !== id);
            localStorage.setItem('cart', JSON.stringify(window.cart));
            renderCart();
            updateCartBadge();
        }
    }

    function renderCart() {
        const el = document.getElementById('cart-items');
        if(!window.cart.length) {
            el.innerHTML = '<div class="text-center py-10 text-gray-400">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
            document.getElementById('cart-total-confirm').innerText = "0 Ø¬.Ù…";
            return;
        }
        
        let total = 0;
        el.innerHTML = window.cart.map(item => {
            total += item.price * item.qty;
            return `
            <div class="flex gap-3 bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-2">
                <img src="${(item.images||[])[0]}" class="w-16 h-16 rounded-lg object-cover bg-gray-50">
                <div class="flex-1">
                    <h4 class="font-bold text-sm text-gray-800">${item.name}</h4>
                    <p class="text-xs text-gray-500">${item.color} | Ù…Ù‚Ø§Ø³ ${item.size}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-bold text-[#4b5f28]">${item.price * item.qty} Ø¬.Ù…</span>
                        <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-1">
                            <button onclick="updateQty('${item.cartId}', -1)" class="w-6 h-6 flex items-center justify-center text-gray-600 font-bold">-</button>
                            <span class="text-xs font-bold">${item.qty}</span>
                            <button onclick="updateQty('${item.cartId}', 1)" class="w-6 h-6 flex items-center justify-center text-gray-600 font-bold">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
        document.getElementById('cart-total-confirm').innerText = total + " Ø¬.Ù…";
    }

    function updateCartBadge() {
        const count = window.cart.reduce((a,b)=>a+b.qty,0);
        const b = document.getElementById('cart-badge');
        b.innerText = count;
        if(count > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Back-end Order)
    window.confirmOrder = async function() {
        if(!window.cart.length) return toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'error');
        if(!currentUser) return openAuthModal(); // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„

        const name = document.getElementById('c-name').value;
        const address = document.getElementById('c-address').value;
        
        if(!name || !address) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');

        const btn = document.getElementById('confirm-order-btn');
        btn.disabled = true; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

        try {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await setDoc(doc(db, "users", currentUser.uid), { name, address }, { merge: true });

            const orderData = {
                items: window.cart,
                total: window.cart.reduce((a,b)=>a+(b.price*b.qty),0),
                user: { uid: currentUser.uid, phone: currentUser.phoneNumber, name, address },
                status: 'new',
                timestamp: Date.now()
            };

            const docRef = await addDoc(collection(db, "orders"), orderData);
            const orderId = docRef.id.slice(0, 6).toUpperCase();
            
            // Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ù†Ù…Ù‚Ø©
            let msg = `ğŸ›ï¸ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ #${orderId}*\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nğŸ“± Ù‡Ø§ØªÙ: ${currentUser.phoneNumber}\nğŸ“ Ø¹Ù†ÙˆØ§Ù†: ${address}\n\nğŸ›’ *Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*\n`;
            window.cart.forEach(i => msg += `- ${i.name} (${i.color}/${i.size}) x${i.qty}\n`);
            msg += `\nğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${orderData.total} Ø¬.Ù…*`;

            window.open(`https://wa.me/201020468021?text=${encodeURIComponent(msg)}`, '_blank');
            
            window.cart = []; localStorage.setItem('cart', '[]'); updateCartBadge(); closeCart();
            document.getElementById('order-number-display').innerText = `#${orderId}`;
            document.getElementById('order-success-modal').classList.remove('hidden');
        } catch(e) {
            console.error(e);
            toast('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹', 'error');
        }
        btn.disabled = false; btn.innerText = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
    }

    window.closeOrderSuccess = function() { document.getElementById('order-success-modal').classList.add('hidden'); }
   </script>
 </body>
</html>
